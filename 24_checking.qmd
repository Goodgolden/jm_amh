---
title: "Checking"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warnings = FALSE,
                      message = FALSE,
                      comment = "#>",
                      #results = "hide",
                      digits = 4,
                      error = FALSE)

## clean the R environment
graphics.off()
rm(list = ls())
freshr::freshr()

## load packages
library(here, quietly = TRUE)
library(tidyverse, quietly = TRUE)
library(JMbayes2, quietly = TRUE)
library(survival, quietly = TRUE)
library(knitr, quietly = TRUE)
library(kableExtra, quietly = TRUE)

## check the directory for the file
# here::dr_here()
# here::set_here()
```


## Kaplan-Meire Curve

```{r}
swan_amh1 <- read_csv("data-raw/swan_amh1.csv") %>%
  mutate(meno = as.character(meno))
test_amh1 <- read_csv("data-raw/test_amh1.csv") %>% 
  mutate(event = 1)
all_amh1 <- bind_rows(swan_amh1, test_amh1) %>%
  mutate(train = ifelse(train == 0, "testing", "training"),
         train = as.factor(train))

## pullout the life tbl for the test_amh1
```

```{r}

km.plot <- function(var, 
                    vard) {
  vard <- as.factor(vard)
  surv1 <- paste("Surv(start_time, etime, event) ~", 
                 var, sep = " ")
  sfit <- survfit(formula(surv1),
                  data = all_amh1)
  lev <- levels(vard)
  str(vard)
  nlev <- nlevels(vard)
  plot(sfit, 
       lty = 1:nlev,
       lwd = 2, 
       col = 1:nlev,
       main = var)
  legend("topright", lev, 
         lty = 1:nlev, 
         col = 1:nlev, 
         lwd = 2,
         bty = "n")
}

km.plot(var = "train", vard = all_amh1$train)

```

```{r}
load("data/test_amh0.rda")
test_amh01 <- test_amh0 %>%
  mutate(site = case_when(site == "11" ~ "M",
                          site == "12" ~ "B",
                          site =="13" ~ "C",
                          site =="14" ~ "UCD",
                          site =="15" ~ "UCLA",
                          site =="16" ~ "NJ",
                          site =="17" ~ "P"),
         lamh = log(amh),
         ethnic = factor(ethnic, levels = c("CAUCA", "BLACK",
                                            "CHINE", "HISPA",
                                            "JAPAN")),
         bmi_cat = as.factor(bmi_cat),
         # site = factor(site, levels = c("B", "C", "M",
         #                                "NJ", "P",
         #                                "UCD", "UCLA")),
         smoke = factor(smoke, levels = c("Never Smoked" ,
                                          "Past Only",
                                          "Current Smoker"))) %>% 
  cbind(model.matrix(~ 1 + site + ethnic + smoke,
                     data = .)) %>%
  janitor::clean_names() %>%
  dplyr::select(-intercept) %>%
  dplyr::select(order(colnames(.))) %>% 
  filter(!is.na(time))
load("data/swan_amh03.rda")
swan_amh04 <- swan_amh03 %>%
  group_by(id) %>%
  arrange(time) %>%
  slice(1L) %>%
  dplyr::select(id, lamh0 = lamh) %>%
  mutate(id = as.character(id))

swan_amh03 <- swan_amh03 %>%
  mutate(id = as.character(id)) %>%
  full_join(swan_amh04, by = "id") %>%
  mutate(bmi_cat = case_when(bmi < 25 ~ 1,
                             bmi >= 25 & bmi < 30 ~ 2,
                             bmi >= 30 ~ 3),
         bmi_cat = as.factor(bmi_cat))
```


```{r}
train03 <- swan_amh03 %>% 
  ungroup() %>%
  # filter(!is.na(amh)) %>% 
  group_by(id) %>%
  dplyr::summarize(visit = n()) %>%
  as.data.frame()

test03 <- test_amh01 %>% 
  # filter(!is.na(amh)) %>% 
  ungroup() %>%
  group_by(id) %>%
  dplyr::summarize(visit = n()) %>%
  as.data.frame() %>%
  mutate(visit = as.numeric(visit))

plot1 <- ggplot() +
  geom_histogram(data = train03, aes(x = visit), 
                 fill = "blue", 
                 stat = "count",
                 binwidth = 1,
                 alpha = 0.5) +
  geom_histogram(data = test03, aes(x = visit),
                 fill = "red", 
                 stat = "count",
                 binwidth = 1,
                 alpha = 0.5) +
  labs(title = "Histogram of the number of visits",
       x = "Number of visits",
       y = "Frequency") +
  theme_minimal()
plot1

```


```{r}
train03 <- swan_amh03 %>% 
  ungroup() %>%
  filter(!is.na(amh)) %>% 
  group_by(id) %>%
  dplyr::summarize(visit = n()) %>%
  as.data.frame()

test03 <- test_amh01 %>% 
  filter(!is.na(amh)) %>% 
  ungroup() %>%
  group_by(id) %>%
  dplyr::summarize(visit = n()) %>%
  as.data.frame() %>%
  mutate(visit = as.numeric(visit))

plot2 <- ggplot() +
  geom_histogram(data = train03, aes(x = visit), 
                 fill = "blue", 
                 stat = "count",
                 binwidth = 1,
                 alpha = 0.5) +
  geom_histogram(data = test03, aes(x = visit),
                 fill = "red", 
                 stat = "count",
                 binwidth = 1,
                 alpha = 0.5) +
  labs(title = "Histogram of the number of visits",
       x = "Number of visits",
       y = "Frequency") +
  theme_minimal()
plot2
```

```{r}
#| fig.width: 5
#| fig.height: 4
plot3 <- ggplot() +
  geom_line(data = test_amh01,
            aes(x = time, y = lamh, group = id),
            color = "#8B3A3A", alpha = 0.1) +
  geom_line(data = swan_amh03, 
            aes(x = time, y = lamh, group = id),
            color = "#27408B", alpha = 0.1) +
  geom_line(data = margin_data,
            aes(x = time, y = lamh),
            size = 1,
            color = "#fdc500") 
plot3 + ylim(c(0, 7)) +
  # labs(title = "SWAN-AMH AUC and CIs (wrap by time interval)") +
  theme_bw() +
  xlab("Time (year)") +
  ylab("Longitudinal Outcome") +
  theme(legend.position = "none",
        # panel.grid = element_blank(),
        # plot.margin = margin(t = 20, b = 8),
        # axis.text = element_blank(),
        # axis.title = element_blank(),
        strip.text = element_text(hjust = 0.5,
                                  lineheight = 0.1))
```


```{r}
# load("results/jmb2_119_test_auc_chain5_it500k_thin100_total2.5k.Rdata")
# tbl_auc_value_rate_test %>% knitr::kable()

load("results/new_jmb2_119_test_auc_chain5_it500k_thin100_total2.5k.Rdata")
tbl_auc_value_rate_test %>% knitr::kable()

load("results/jmb2_119_auc_train_chain_5_it50k_thin100_total2.5k.Rdata")
tbl_auc_value_rate %>% knitr::kable()
```

Testing

Dt1	Dt2	Dt3	Dt4	Dt5
Tstart2_test	NA	      NA	    0.3706	0.7649	0.8830
Tstart3_test	NA    	  0.9845	0.9449	0.8072	0.7802
Tstart4_test	0.9196  	0.8645	0.9076	0.8201	0.7957
Tstart5_test	*0.9558*	0.8938	0.8584	0.8226	0.7766
Tstart6_test	*0.8469*	0.8735	0.8284	0.7672	0.7681
Tstart8_test	*0.8030*	0.7324	0.7708	0.7824	0.8207

Training

Dt1	Dt2	Dt3	Dt4	Dt5
Tstart2_train	 NA	    0.6928	0.7645	0.7660	0.7789
Tstart3_train	 0.4380	0.8127	0.7943	0.8066	0.7912
Tstart4_train	 0.9473	0.8295	0.7991	0.7556	0.7735
Tstart5_train	 0.8404	0.8096	0.8035	0.7992	0.8180
Tstart6_train	 0.8123	0.8253	0.8104	0.8251	0.8053
Tstart8_train	 0.7919	0.8088	0.7864	0.7899	0.8340

```{r}
load("results/jmb2_119_brier_chain5_it60k_thin100_total3k.Rdata")
tbl_bs_value_rate %>% knitr::kable()
load("results/jmb2_119_test_brier_chain5_it500k_thin50_total50k.Rdata")
tbl_bs_value_rate_test %>% knitr::kable()
```


Training Brier Score

