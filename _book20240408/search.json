[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "SWAN AMH project analysis",
    "section": "",
    "text": "Do backward selection. Keep site, ethnicity, smoking and bmi\n\n\n\n\n\n\nThe JM package works to fit JM with all covariates, and to calculate AUC. However, it DOES NOT work to calculate the prediction error\n\n\n\n\n\n\nPredicting for next 24 months\nMove the window we’re using to predict: 1 value, 2 values (2 years), 3 values\nCould we use threshold, rate of AMH\n\n\n\n\n\nTry JMBayes for all variables; get AUC and Brier score\nTry a model with all predictor variables\n\n\n\n\n\nEmail Lala about variables like fmp_age and whether smoking status, employment are TVC or fixed\nTry to merge fmp_age from previous dataset and run model\n\n\n\n\n\nDo table 1 for the new data\nRun separate joint models for fixed covariates - not the TVC\n\n\n\n\n\nRun the models for menopuse (also for the other variables_fixed covarites) with JM and JMbayes seperately\nAuc\n\n\n\n\n\nCategorize ethnicity variable (3 categories)\nUse JMBayes, changing seed\n\n\n\n\n\nUse log natural transformation for AMH\n\n\nInclude random slope and random intercept\n\n\nLOD? It is 1.45/1.85 (Lala); Mahi should check on this. Lala and Mary don’t’ think we should have many of these cases given the level of AMH is low after FMP - 428(12.05%) cases that have amh 1.45\nBuild figures of dynamic prediction.\nApply in validation cohort\nQuestions for prediction model:\n\n\nAt what level of amh, there is more chance of having fmp? - need another model\nHow many AMH measures do we need to do a good job with prediction?\n\n\nIs menopause a TVC?\nCensored cases? We won’t look at now\nLong model will only have time\nMary and Lala will be working on selecting covariates for survival model.\nLIST of covariates from Mary\nRace/ethnicity (NS)—this was the primary covariate of interest in the manuscript.\nOverall health (baseline)\nEducation\nPrior use of oral contraceptives (before enrollment into swan)\nPhysical activity (tv)\nSmoking (tv?)\nEmployment status (tv)\nAlcohol (tv)\nWeight (baseline); CHECK if BMI is ok\nChildren (#)\n\n\n\n\n\nThreshold regression for joint modeling of FSH and AMH; trying to predict FMP\n~300 patients with AMH but had a hysterectomy\nWhat are you using as time 0? Age 42 and measure everybody from there.\nThere are some challenges with below LOD (limit of detection); Mike is thinking that they will use imputation for these cases\nTime variable: age at each visit -42 (start everybody at 42; so that a women who started data at 46, would be 4 years)\n\n\n\n\n\n\nFit the models using methods other than weibull-PH-aGH\nTable 1 correction _ factor the MSTATUS variable\nUse MSTATUS and ETHNICITY as covariates\nLeft truncation model\nFormat the data by subtracting agecont and min enrollment age –new time variable\nLook into how to perform dynamic predictions for survival outcome based on different windows of time for the long outcome\nEJC needs to think about whether we can fit a joint model with left truncation for the survival outcome\n\n\n\n\n\nFormat the AMH data two different ways:\n\n\nFormat so that the beginning of the study is the enrollment age for every individual. Save the data. SPEND more time with this dataset (analyzing below)\nFormat the AMH data so that the beginning of the study is age 43 for every woman. Save the data. Note that the baseline covariates need to be defined by the values of the first time they were measured.\n\n\nTable 1\nPractice fitting a joint model with our data (two versions)\nPractice calculating dynamic predictions for our outcome\nUse some smoothing (e.g. loess) to get a sense of the functional of time in the longitudinal trajectories of AMH (do we need to consider splines?)\nDoes the JM package allow for time-varying covariates (TVC) to be included in the survival model?\n\n\n\nEJC is almost positive this is possible b/c the survival model gets fitted using the coxph function which allows for TVC. Note that data for TVC need to be formatted in the counting process format.\n\n\nTime-varying covariates can be included in the Cox proportional hazards component of the joint model.\n\n\nHow do we do some goodness of fit (GOF)? Could we do model comparison using the JM package?\nFollow the example in JMBayes tutorial on dynamic prediction (we want to do sort of the same)\n\n\n\n\n\nSWAN: Lala is 30% as analyst\nData coordinating center at Pittsburg\nNenette is one of the PIs of the study\nStudy has been going on since 1990; annual visits (up 16 visits)\n3302 women in the sample (at baseline)\nSurveys collected every year (mostly)\nSome variables have been modeled as TVC and others as fixed\nCovariates of interest:\nAMH is the hormone of interest: long data\nNew way of measuring AMH; can detect below the limit of detection\nOutcome of interest (time to): Final menstrual period; we don’t’ have that for everyone\nThere is a sample of ~1400 (only about 1k with at least 3 measures of AMH) for whom we have final menstrual period\nCovariates:\nBMI, smoking there might be TVC\nThere might be a change point\nSample\nBeginning of the study: enrolling women around 40 premenopausal with 3 regular cycles\nThere is ethnic diversity\nMenopausal stage; 60 days of menorrea (defines women are in the transition)\nThere might be left truncation\nLeave 1/3 for testing\nFuture work:\n\nChange point\nSubgroups\nIncluding those individuals who did not transition (hormonal treatment)\nModel below the limit of detect\nDo you have regular measures of AMH and new assay?\nThere is other measurements TVC of hormones (FSH and estradiol)\n\n\n\n\n-updated Nov 1st, 2023 - Watch EJC lect on joint models and go through code; note we want to do dynamic prediction based on joint models (a step above joint models) - Reproduce a data example using package JMBAyes; look through the vignettes and run through example (make sure you understand what the example analysis is doing) - Do the simulation in 2-3 different ways: maybe the one you have originally done it, using arrays, and see if you can use lists (or maybe Randy has a suggestion). DONE -\n\n\n\n\nUse arrays in the simulation study; try lists too (in an alternative program)\nStart reading resources on dynamic prediction https://github.com/drizopoulos/JMbayes\n\nHere are a few refs: 1. Rizopolous (2011 Biometrics): this is the first paper on this topic of dynamic prediction. 2. Campbell (2021 BMC). The survival outcome is interval censored but it will provide an idea of what we are trying to do; note that we programmed our likelihood here but the ideas are similar to Rizopolous and the package below. This paper might be easier to follow at first than the Rizopolous (2011 Biometrics). 3. JMBayes package – see vignette and Rizopolous (2016): software paper of JMBayes. As an exercise it’d be helpful for you to work out an example provided by the package or in the website just to see how things work. Then in the next step we can try to apply to our data. https://www.drizopoulos.com/#inaugural_speech https://www.drizopoulos.com/vignettes/dynamic_predictions\n\n\n\n\nConduct a simulation study of a basic linear regression; objective is to estimate the slope of the regression\nRead paper from K Miller and research plan of grant"
  },
  {
    "objectID": "intro.html",
    "href": "intro.html",
    "title": "Introduction",
    "section": "",
    "text": "This is a book created from markdown and executable code.\nThis project contains the works for TSA shoulder datasets. Here are the details for each dataset. Interested varaibles are labeled in italic and bold."
  },
  {
    "objectID": "intro.html#base-data",
    "href": "intro.html#base-data",
    "title": "Introduction",
    "section": "Base data",
    "text": "Base data\nThis tab contains a list of all TSA/Reverse TSA surgeries as described above. One line for each surgery. Other variables at the time of surgery are also included.\n\nEMPI_DEIDENTIFIED\n\ncross the tables unique id probably for shoulder not for person, is it true?)\nUnique patient identifier that can be linked between data tables\nCategorical variable (sequence of letters and numbers)\n\nPATIENT_AGE\n\nThe age of the patient at the time of surgery\nInteger variable (years)\n\nPATIENT_GENDER\n\nIndicator of patient-reported sex\nCategorical variable (male or female)\n\nPRIMARY_PAYER\n\nPatient’s insurance provider\nCategorical variable (name of insurance)\n\nSURGERY_TYPE\n\nType of shoulder arthroplasty performed\nCategorical variable (Reverse TSA or TSA)\n\nSURGERY_DT\n\nTimestamp of surgical date\nTime variable (YYYY-mm-dd hh:mm:ss)\n\nBMI\n\nBody mass index\nContinuous variable (kg/m2)\n\nADI_VALUE\n\nUtah Area Deprivation Index standardized value. The ADI is a proxy of socioeconomic status with values ranging from -40.0 to 139.4. Higher values indicate greater levels of deprivation. More details available here: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5019337/.\nContinuous variable (standardized value)\n\nADI_QUINTILE\n\nUtah Area Deprivation Index score divided into categories from 1-5. Higher categories indicate greater levels of deprivation\nOrdinal variable (1-5), 20% per level"
  },
  {
    "objectID": "intro.html#outcomes",
    "href": "intro.html#outcomes",
    "title": "Introduction",
    "section": "Outcomes",
    "text": "Outcomes\nThis tab contains a list of all DASH or QDASH outcomes collected for the patient population contained in the “base” population. Outcomes are collected for all patients from 1/1/2016 to allow for any pre-surgical values to be pulled if needed. Outcomes are pulled from iCentra (Cerner), ROMS 1, and ROMS 2.\n\nEMPI_DEIDENTIFIED\n\nUnique patient identifier that can be linked between data tables\nCategorical variable (sequence of letters and numbers)\n\nOUTCOME_TYPE\n\nIndicates whether the full DASH or QuickDASH was collected\nCategorical variable (DASH or QDASH)\nseems the similar to each other\n\n\nPotentially be a variable to adjust\n\nOUTCOME_DT\n\nTimestamp indicating when outcome was assessed\nTime variable (YYYY-mm-dd hh:mm:ss)\n\nOUTCOME_SCORE\n\nRaw value of either DASH or QuickDASH where higher scores indicate greater disability\nInteger variable (0-100)"
  },
  {
    "objectID": "intro.html#pain",
    "href": "intro.html#pain",
    "title": "Introduction",
    "section": "Pain",
    "text": "Pain\nThis tab contains a list of all pain scores collected for the patient population contained in the “base” population. Only pain scores collected at the time of the DASH/QDASH are included. Pain scores are collected for all patients from 1/1/2016 to allow for any pre-surgical values to be pulled if needed. Pain Values are pulled from iCentra (Cerner), ROMS 1, and ROMS 2\n\nEMPI_DEIDENTIFIED\n\nUnique patient identifier that can be linked between data tables\nCategorical variable (sequence of letters and numbers)\n\nPAIN_DT\n\nTimestamp indicating when patient’s pain was assessed\nTime variable (YYYY-mm-dd hh:mm:ss)\n\nPAIN_SCORE\n\nPatient-reported pain via the Numeric Pain Rating Scale where 0 = no pain and 10 = worst pain imaginable\nInteger variable (1-10)"
  },
  {
    "objectID": "intro.html#range-of-motion",
    "href": "intro.html#range-of-motion",
    "title": "Introduction",
    "section": "Range of Motion",
    "text": "Range of Motion\nThis tab contains all data points for the range of motion documented in iCentra (Cerner) for the “base” population of patients. This data is a really messy, but I’m just providing it in its raw state as requested. The data points are collected for all patients from 1/1/2016 to allow for any pre-surgical values to be pulled if needed.\n\nEMPI_DEIDENTIFIED\n\nUnique patient identifier that can be linked between data tables\nCategorical variable (sequence of letters and numbers)\n\nRANGE_OF_MOTION_TYPE\n\nTherapist description of how range of motion was assessed. This can include the plane of motion, patient positioning, or other pertinent factors\nCharacter variable that needs to be transformed to categorical\n\nRANGE_OF_MOTION_TIMESTAMP\n\nTimestamp indicating when range of motion was assessed\nTime variable (YYYY-mm-dd hh:mm:ss)\n\nRANGE_OF_MOTION_VALUE\n\nTherapist indicated value of the assessed range of motion. Primarily, this variable continues integers that indicate the degrees of motion assessed, but it may also contain characters that describe the type or amount of motion.\nCharacter variable that needs to be transformed to integer"
  },
  {
    "objectID": "01_table1.html#data-cleaning",
    "href": "01_table1.html#data-cleaning",
    "title": "\n1  Table1\n",
    "section": "\n1.1 Data Cleaning",
    "text": "1.1 Data Cleaning\nThe data cleaning process codes are saved in the data-raw folder swan_amh.R file. The data cleaning process is done in the for both numeric swan_amh0 and categorical swan_amh1 data files. The data description is saved in the R folder as 00_data files.\nThe cleaned data .rda is saved in the data folder as a part of the package which do not need to extra loading, if installed as a package. The extra copy of .csv files are saved in the data-raw folder for the reference.\n\nCodeload(here(\"data\", \"swan_amh1.rda\"))\n\n\nHere is the final clean dataset swan_amh1 with 600 individuals and 16 variables.\n\nCodeswan_amh1"
  },
  {
    "objectID": "01_table1.html#building-table1",
    "href": "01_table1.html#building-table1",
    "title": "\n1  Table1\n",
    "section": "\n1.2 Building Table1",
    "text": "1.2 Building Table1\n\nCodetable1 <- swan_amh1 %>%\n  ungroup() %>%\n  mutate(children = as.numeric(children),\n         parity = case_when(parity == 0 ~ \"None\",\n                            parity == 1 ~ \"One\",\n                            parity == 2 ~ \"Two\",\n                            parity == 3 ~ \"Three\",\n                            parity == 4 ~ \"More than three\"),\n         parity = factor(parity, levels = c(\"None\", \"One\",\n                                               \"Two\", \"Three\",\n                                               \"More than three\"))) %>%\n  dplyr::select(age, ethnic, married,\n                alcohol, smoke, bc_pills,\n                bmi, health, phys_act, amh,\n                parity, children, \n                employed, edu, site)  %>%\n  tbl_summary(by = site,\n              missing = \"ifany\",\n              label = list(c(\"age\") ~ \"Age (years)\",\n                           c(\"ethnic\") ~ \"Ethnicity / Race\",\n                           c(\"married\") ~ \"Marital Status\",\n                           c(\"alcohol\") ~ \"Alcohol Use\",\n                           c(\"smoke\") ~ \"Smoking History\",\n                           c(\"bc_pills\") ~ \"Ever use of BC Pills\",\n                           c(\"bmi\") ~ \"BMI\",\n                           c(\"health\") ~ \"Overall Health\",\n                           c(\"phys_act\") ~ \"Physical Activity Score\",\n                           c(\"amh\") ~ \"AMH\",\n                           c(\"parity\") ~ \"Parity\",\n                           c(\"children\") ~ \"Children\",\n                           c(\"employed\") ~ \"Employment Status\",\n                           c(\"edu\") ~ \"Educational Attainment\"),\n              type = list(all_continuous() ~ \"continuous2\",\n                          c(\"children\") ~ \"continuous2\"),\n              statistic = list(all_continuous() ~ c(\"{mean} ({sd})\",\n                                                    \"{median}\",\n                                                    \"[{min}, {max}]\"),\n                               all_categorical() ~ \"{n} / {N} ({p}%)\")) %>%\n  modify_header(label = \"**Characteristics**\") %>%\n  # update the column header\n  bold_labels() %>%\n  # add_overall() %>%\n  italicize_labels()\n\n\nCurrent Table1 is created, grouped by the site variable.\nNeed to be changed and updated with future requirements.\n\nCodeset_flextable_defaults(font.size = 8, \n                       # text.align = \"left\",\n                       theme_fun = theme_zebra,\n                       padding = 2)\ntable1 %>% \n  as_flex_table() %>%\n  fontsize(i = 1, size = 8, part = \"header\")\n\n\n\n\n\nDescriptive Statistics for SWAN AMH Data\n\nCharacteristics\nB, N = 961\nC, N = 761\nM, N = 1031\nNJ, N = 271\nP, N = 741\nUCD, N = 1021\nUCLA, N = 1221\n\n\n\nAge (years)\n\n\n\n\n\n\n\n\n\nMean (SD)\n46.75 (2.44)\n46.42 (2.31)\n46.33 (2.55)\n46.22 (2.26)\n46.20 (2.13)\n46.50 (2.55)\n46.34 (2.42)\n\n\nMedian\n47.00\n46.00\n46.00\n46.00\n46.00\n46.00\n46.00\n\n\n[Range]\n[42.00, 52.00]\n[43.00, 53.00]\n[42.00, 53.00]\n[43.00, 52.00]\n[43.00, 51.00]\n[43.00, 53.00]\n[43.00, 53.00]\n\n\nEthnicity / Race\n\n\n\n\n\n\n\n\n\nCAUCA\n57 / 96 (59%)\n35 / 76 (46%)\n39 / 103 (38%)\n9 / 27 (33%)\n48 / 74 (65%)\n40 / 102 (39%)\n37 / 122 (30%)\n\n\nBLACK\n39 / 96 (41%)\n41 / 76 (54%)\n64 / 103 (62%)\n0 / 27 (0%)\n26 / 74 (35%)\n0 / 102 (0%)\n0 / 122 (0%)\n\n\nCHINE\n0 / 96 (0%)\n0 / 76 (0%)\n0 / 103 (0%)\n0 / 27 (0%)\n0 / 74 (0%)\n62 / 102 (61%)\n0 / 122 (0%)\n\n\nHISPA\n0 / 96 (0%)\n0 / 76 (0%)\n0 / 103 (0%)\n18 / 27 (67%)\n0 / 74 (0%)\n0 / 102 (0%)\n0 / 122 (0%)\n\n\nJAPAN\n0 / 96 (0%)\n0 / 76 (0%)\n0 / 103 (0%)\n0 / 27 (0%)\n0 / 74 (0%)\n0 / 102 (0%)\n85 / 122 (70%)\n\n\nMarital Status\n\n\n\n\n\n\n\n\n\nNot Married/Partnered\n38 / 96 (40%)\n24 / 76 (32%)\n46 / 103 (45%)\n8 / 27 (30%)\n29 / 74 (39%)\n20 / 102 (20%)\n26 / 122 (21%)\n\n\nMarried/Partnered\n58 / 96 (60%)\n52 / 76 (68%)\n57 / 103 (55%)\n19 / 27 (70%)\n45 / 74 (61%)\n82 / 102 (80%)\n96 / 122 (79%)\n\n\nAlcohol Use\n\n\n\n\n\n\n\n\n\nNone\n33 / 96 (34%)\n33 / 76 (43%)\n67 / 103 (65%)\n9 / 27 (33%)\n36 / 74 (49%)\n67 / 102 (66%)\n63 / 122 (52%)\n\n\n<1/wk\n10 / 96 (10%)\n10 / 76 (13%)\n7 / 103 (6.8%)\n7 / 27 (26%)\n12 / 74 (16%)\n6 / 102 (5.9%)\n19 / 122 (16%)\n\n\n1-7/wk\n38 / 96 (40%)\n23 / 76 (30%)\n23 / 103 (22%)\n10 / 27 (37%)\n23 / 74 (31%)\n14 / 102 (14%)\n30 / 122 (25%)\n\n\n>7/wk\n15 / 96 (16%)\n10 / 76 (13%)\n6 / 103 (5.8%)\n1 / 27 (3.7%)\n3 / 74 (4.1%)\n15 / 102 (15%)\n10 / 122 (8.2%)\n\n\nSmoking History\n\n\n\n\n\n\n\n\n\nNever Smoked\n52 / 96 (54%)\n50 / 76 (66%)\n60 / 103 (58%)\n18 / 27 (67%)\n34 / 74 (46%)\n78 / 102 (76%)\n81 / 122 (66%)\n\n\nPast Only\n37 / 96 (39%)\n15 / 76 (20%)\n19 / 103 (18%)\n4 / 27 (15%)\n24 / 74 (32%)\n20 / 102 (20%)\n30 / 122 (25%)\n\n\nCurrent Smoker\n7 / 96 (7.3%)\n11 / 76 (14%)\n24 / 103 (23%)\n5 / 27 (19%)\n16 / 74 (22%)\n4 / 102 (3.9%)\n11 / 122 (9.0%)\n\n\nEver use of BC Pills\n\n\n\n\n\n\n\n\n\nNever\n26 / 96 (27%)\n11 / 76 (14%)\n22 / 103 (21%)\n8 / 27 (30%)\n18 / 74 (24%)\n28 / 102 (27%)\n42 / 122 (34%)\n\n\nEver use BC pills\n70 / 96 (73%)\n65 / 76 (86%)\n81 / 103 (79%)\n19 / 27 (70%)\n56 / 74 (76%)\n74 / 102 (73%)\n80 / 122 (66%)\n\n\nBMI\n\n\n\n\n\n\n\n\n\nMean (SD)\n28 (7)\n30 (6)\n32 (9)\n29 (9)\n29 (8)\n24 (6)\n24 (5)\n\n\nMedian\n26\n28\n31\n28\n28\n23\n23\n\n\n[Range]\n[20, 50]\n[19, 50]\n[16, 56]\n[18, 56]\n[16, 50]\n[18, 54]\n[17, 42]\n\n\nOverall Health\n\n\n\n\n\n\n\n\n\nExcellent\n33 / 96 (34%)\n17 / 76 (22%)\n14 / 103 (14%)\n4 / 27 (15%)\n13 / 74 (18%)\n26 / 102 (25%)\n40 / 122 (33%)\n\n\nVery Good\n38 / 96 (40%)\n29 / 76 (38%)\n34 / 103 (33%)\n12 / 27 (44%)\n36 / 74 (49%)\n39 / 102 (38%)\n45 / 122 (37%)\n\n\nGood\n16 / 96 (17%)\n23 / 76 (30%)\n39 / 103 (38%)\n6 / 27 (22%)\n20 / 74 (27%)\n23 / 102 (23%)\n24 / 122 (20%)\n\n\nFair/Poor\n9 / 96 (9.4%)\n7 / 76 (9.2%)\n16 / 103 (16%)\n5 / 27 (19%)\n5 / 74 (6.8%)\n14 / 102 (14%)\n13 / 122 (11%)\n\n\nPhysical Activity Score\n\n\n\n\n\n\n\n\n\nMean (SD)\n8.04 (1.78)\n7.88 (1.57)\n7.35 (1.76)\n7.40 (1.79)\n7.88 (1.94)\n7.48 (1.72)\n7.99 (1.75)\n\n\nMedian\n7.95\n7.75\n7.25\n7.15\n7.70\n7.43\n7.70\n\n\n[Range]\n[3.40, 12.20]\n[4.75, 11.85]\n[4.60, 12.45]\n[3.40, 11.10]\n[4.00, 12.05]\n[4.15, 11.85]\n[4.70, 12.80]\n\n\nAMH\n\n\n\n\n\n\n\n\n\nMean (SD)\n570 (658)\n548 (700)\n472 (665)\n522 (622)\n420 (502)\n446 (661)\n724 (875)\n\n\nMedian\n326\n277\n230\n321\n216\n177\n412\n\n\n[Range]\n[1, 3,652]\n[1, 3,124]\n[1, 3,270]\n[1, 2,470]\n[1, 2,128]\n[1, 3,249]\n[1, 4,652]\n\n\nParity\n\n\n\n\n\n\n\n\n\nNone\n26 / 96 (27%)\n8 / 76 (11%)\n12 / 103 (12%)\n5 / 27 (19%)\n13 / 74 (18%)\n21 / 102 (21%)\n26 / 122 (21%)\n\n\nOne\n22 / 96 (23%)\n6 / 76 (7.9%)\n12 / 103 (12%)\n4 / 27 (15%)\n14 / 74 (19%)\n14 / 102 (14%)\n16 / 122 (13%)\n\n\nTwo\n27 / 96 (28%)\n27 / 76 (36%)\n30 / 103 (29%)\n9 / 27 (33%)\n25 / 74 (34%)\n44 / 102 (43%)\n48 / 122 (39%)\n\n\nThree\n13 / 96 (14%)\n17 / 76 (22%)\n24 / 103 (23%)\n4 / 27 (15%)\n15 / 74 (20%)\n19 / 102 (19%)\n24 / 122 (20%)\n\n\nMore than three\n8 / 96 (8.3%)\n18 / 76 (24%)\n25 / 103 (24%)\n5 / 27 (19%)\n7 / 74 (9.5%)\n4 / 102 (3.9%)\n8 / 122 (6.6%)\n\n\nChildren\n\n\n\n\n\n\n\n\n\nMean (SD)\n1.55 (1.30)\n2.54 (1.68)\n2.48 (1.54)\n2.22 (1.78)\n1.85 (1.21)\n1.73 (1.14)\n1.79 (1.22)\n\n\nMedian\n1.50\n2.00\n2.00\n2.00\n2.00\n2.00\n2.00\n\n\n[Range]\n[0.00, 5.00]\n[0.00, 12.00]\n[0.00, 9.00]\n[0.00, 7.00]\n[0.00, 4.00]\n[0.00, 5.00]\n[0.00, 5.00]\n\n\nEmployment Status\n\n\n\n\n\n\n\n\n\nUnemployed\n13 / 96 (14%)\n10 / 76 (13%)\n27 / 103 (26%)\n6 / 27 (22%)\n10 / 74 (14%)\n7 / 102 (6.9%)\n31 / 122 (25%)\n\n\nEmployed\n83 / 96 (86%)\n66 / 76 (87%)\n76 / 103 (74%)\n21 / 27 (78%)\n64 / 74 (86%)\n95 / 102 (93%)\n91 / 122 (75%)\n\n\nEducational Attainment\n\n\n\n\n\n\n\n\n\nHigh School or Less\n13 / 96 (14%)\n9 / 76 (12%)\n28 / 103 (27%)\n15 / 27 (56%)\n17 / 74 (23%)\n27 / 102 (26%)\n16 / 122 (13%)\n\n\nSome College\n28 / 96 (29%)\n21 / 76 (28%)\n46 / 103 (45%)\n6 / 27 (22%)\n29 / 74 (39%)\n14 / 102 (14%)\n46 / 122 (38%)\n\n\nCollege degree or higher\n55 / 96 (57%)\n46 / 76 (61%)\n29 / 103 (28%)\n6 / 27 (22%)\n28 / 74 (38%)\n61 / 102 (60%)\n60 / 122 (49%)\n\n\n1n / N (%)"
  },
  {
    "objectID": "01_table1.html#saving-table1",
    "href": "01_table1.html#saving-table1",
    "title": "\n1  Table1\n",
    "section": "\n1.3 Saving Table1",
    "text": "1.3 Saving Table1\n\nCodelibrary(xtable)\nxtable(as.data.frame(table1), type = \"latex\",\n      file = paste0(\"figure/swan_amh_01_table1_\", Sys.Date(), \".tex\"))"
  },
  {
    "objectID": "01_table1.html#notes",
    "href": "01_table1.html#notes",
    "title": "\n1  Table1\n",
    "section": "\n1.4 Notes",
    "text": "1.4 Notes\nThe only problem is the location Sites with the Ethnicity groups.\nMissing values are removed from 631 to 600 through data cleaning process.\nSee data-raw/swan_amh.R for the data cleaning process line-375 removed 31 individuals 31/631 = 4.9%."
  },
  {
    "objectID": "02_jm.html#longitudinal-eda",
    "href": "02_jm.html#longitudinal-eda",
    "title": "\n2  JM\n",
    "section": "\n2.1 Longitudinal EDA",
    "text": "2.1 Longitudinal EDA\nThe spaghetti plots for alcohol usage and the amh levels. Linear trend seems reasonable for the AMH levels over time.\nThe longitudinal model will only include time.\n\nswan_amh0 is the longitudinal dataset\nswan_amh1 is the id dataset\n\n\nCode## exploring AMH over time\nplot1 <- ggplot(swan_amh0, \n                aes(x = time, \n                    y = log(amh),\n                    group = as.character(id))) +\n  geom_line(aes(color = alcohol),\n            alpha = 0.5) +\n  geom_smooth(aes(group = 1),\n              method = \"loess\",\n              color = \"black\",\n              se = FALSE) +\n  theme_classic() +\n  theme(legend.position = \"none\") +\n  ylab(\"AMH\")\n\n\n\nCodeplot1\nplot1 + facet_wrap(~alcohol)\n\n\n\n\n\nAMH over time and by alcohol use\n\n\n\n\n\n\nAMH over time and by alcohol use"
  },
  {
    "objectID": "02_jm.html#survival-eda",
    "href": "02_jm.html#survival-eda",
    "title": "\n2  JM\n",
    "section": "\n2.2 Survival EDA",
    "text": "2.2 Survival EDA\n\nCodekm.plot <- function(var, \n                    vard) {\n  vard <- as.factor(vard)\n  surv1 <- paste(\"Surv(start_time, etime, event) ~\", \n                 var, sep = \" \")\n  sfit <- survfit(formula(surv1),\n                  data = swan_amh1)\n  lev <- levels(vard)\n  str(vard)\n  nlev <- nlevels(vard)\n  plot(sfit, \n       lty = 1:nlev,\n       lwd = 2, \n       col = 1:nlev,\n       main = var)\n  legend(\"topright\", lev, \n         lty = 1:nlev, \n         col = 1:nlev, \n         lwd = 2,\n         bty = \"n\")\n}\n\n# table(swan_amh1$alcohol)\n# names(swan_amh1)\n# table(swan_amh1$bmi_cat)\n\nnamelist <- c(\"ethnic\", \"edu\", \"alcohol\", \n              \"employed\", \"health\", \"smoke\",\n              \"married\", \"bc_pills\", \n              \"children\", \"bmi\", \"phys_act\")\n\nop <- par(mfrow = c(6, 2))\nkm.plot(var = \"site\", vard = swan_amh1$site)\n\n#>  Factor w/ 7 levels \"B\",\"C\",\"M\",\"NJ\",..: 3 3 3 3 3 3 3 3 3 3 ...\n\nCodekm.plot(var = \"ethnic\", vard = swan_amh1$ethnic)\n\n#>  Factor w/ 5 levels \"CAUCA\",\"BLACK\",..: 1 2 2 1 2 2 2 2 1 2 ...\n\nCodekm.plot(var = \"alcohol\", vard = swan_amh1$alcohol)\n\n#>  Factor w/ 4 levels \"None\",\"<1/wk\",..: 1 3 3 1 1 4 1 1 1 1 ...\n\nCodekm.plot(var = \"edu\", vard = swan_amh1$edu)\n\n#>  Factor w/ 3 levels \"High School or Less\",..: 3 2 3 3 2 2 1 2 1 2 ...\n\nCodekm.plot(var = \"employed\", vard = swan_amh1$employed)\n\n#>  Factor w/ 2 levels \"Unemployed\",\"Employed\": 2 2 2 2 2 2 1 2 2 2 ...\n\nCodekm.plot(var = \"health\", vard = swan_amh1$health)\n\n#>  Factor w/ 4 levels \"Excellent\",\"Very Good\",..: 2 3 2 2 3 2 4 2 3 2 ...\n\nCodekm.plot(var = \"smoke\", vard = swan_amh1$smoke)\n\n#>  Factor w/ 3 levels \"Never Smoked\",..: 1 3 2 1 1 1 3 1 1 3 ...\n\nCodekm.plot(var = \"married\", vard = swan_amh1$married)\n\n#>  Factor w/ 2 levels \"Not Married/Partnered\",..: 2 1 2 1 2 2 1 1 1 1 ...\n\nCodekm.plot(var = \"bc_pills\", vard = swan_amh1$bc_pills)\n\n#>  Factor w/ 2 levels \"Never\",\"Ever use BC pills\": 2 1 2 1 2 2 1 1 1 2 ...\n\nCodekm.plot(var = \"parity\", vard = swan_amh1$parity)\n\n#>  Factor w/ 5 levels \"0\",\"1\",\"2\",\"3\",..: 4 1 4 1 5 5 5 4 5 2 ...\n\nCodekm.plot(var = \"bmi_cat\", vard = swan_amh1$bmi_cat)\n\n#>  Factor w/ 3 levels \"1\",\"2\",\"3\": 3 2 1 3 1 3 1 3 3 3 ...\n\nCode## continous variables: bmi, phys.act, children\n# summary(swan_amh1$bmi)\n# table(swan_amh1$children) ## maybe use 0, 1, 2, 3, 4, 5+\n\n\n\nKaplan-Meier plots for different variables"
  },
  {
    "objectID": "02_jm.html#longitudinal-submodel-on-logamh",
    "href": "02_jm.html#longitudinal-submodel-on-logamh",
    "title": "\n2  JM\n",
    "section": "\n2.3 Longitudinal submodel on log(AMH)",
    "text": "2.3 Longitudinal submodel on log(AMH)\nThe linear mixed model will only include the time variable, with random slope and random intercept.\n\nCodeswan_amh0$lamh <- log(swan_amh0$amh)\n\n## linear mixed model fit (longitudinal outcome)\nlme.fit0 <- lme(lamh ~ time, \n                data = swan_amh0,\n                random = ~ 1|id)\nlme.fit1 <- lme(lamh ~ time,\n                data = swan_amh0, \n                random = ~ time|id)\n\n\nComparison between the two models. The first model has a random intercept, while the second model has a random slope.\nThe fixed effects are almost the same.\n\nCodetidy(lme.fit0)\n\n\n\n  \n\n\nCodetidy(lme.fit1)\n\n\n\n  \n\n\n\n\nCoderbind(fit0 = glance(lme.fit0),\n      fit1 = glance(lme.fit1))\n\n\n\n  \n\n\n\nThere is a significant difference between the two models. We will use the second model for the joint model.\n\nCodeanova(lme.fit0, lme.fit1)"
  },
  {
    "objectID": "02_jm.html#survivial-submodel",
    "href": "02_jm.html#survivial-submodel",
    "title": "\n2  JM\n",
    "section": "\n2.4 Survivial submodel",
    "text": "2.4 Survivial submodel\n\nCode## get predicted random slopes and plot them against \n## (get the correlation)\n## with time to FMP (before even you fit JM)\n## cox model fit (survival outcome) with left truncation \n## (need to fit model without left truncation)\nsurv.fit0 <- coxph(Surv(start_time, etime, event) ~ ethnic + edu + \n                    alcohol + employed + health +\n                    smoke + married + bc_pills + \n                    children + bmi + \n                    phys_act + cluster(id),\n                  data = swan_amh1, \n                  x = TRUE, \n                  model = TRUE)\n\n## assuming individuals are observed from time 0 - \n## WE WILL USE this model\n## (and do a sensitivity analysis with left trunc)\nsurv.fit1 <- coxph(Surv(etime, event) ~ married + bc_pills +\n                    children + bmi + phys_act +\n                    factor(site) + factor(ethnic) +\n                    factor(smoke) + factor(edu) +\n                    factor(alcohol) + factor(employed) +\n                    factor(health),\n                  data = swan_amh1,\n                  x = TRUE, \n                  model = TRUE)\n\n\n## with only continuous predictors\nsurv.fit2 <- coxph(Surv(etime, event) ~ married + bc_pills + \n                    children + bmi + phys_act, \n                  data = swan_amh1, \n                  x = TRUE,\n                  model = TRUE)\n\n\nHere are the summary statistics for the three models.\n\nCoderbind(fit0 = glance(surv.fit0), \n      fit1 = glance(surv.fit1), \n      fit2 = glance(surv.fit2)) %>%\n  mutate(formula = c(surv.fit0$formula, \n                     surv.fit1$formula, \n                     surv.fit2$formula),\n         formula = as.character(formula)) %>%\n  dplyr::select(logLik, AIC, BIC, formula,\n                r.squared, concordance) \n\n\n\n  \n\n\n\nThis is the final survival model that we will use for the joint model.\n\nCodetidy(surv.fit1)"
  },
  {
    "objectID": "02_jm.html#joint-model",
    "href": "02_jm.html#joint-model",
    "title": "\n2  JM\n",
    "section": "\n2.5 Joint model",
    "text": "2.5 Joint model\nHere is the simplest joint model with the exploratory analysis.\n\nCode## joint model fit\njoint.fit1 <- jointModel(lme.fit1,\n                        surv.fit1, \n                        timeVar = \"time\", \n                        method = \"piecewise-PH-aGH\")\n\n# \"weibull-PH-aGH\"\n# joint.fit.laplace <- jointModel(lme.fit1,\n#                             surv.fit1, \n#                             timeVar = \"time\", \n#                             method = \"ch-Laplace\")\n\n\nThe summaries of the joint model.\n\nCodesummary(joint.fit1)[[1]]\n\n#>                  Value    Std.Err   z-value p-value\n#> (Intercept)  7.8622487 0.09790235  80.30705       0\n#> time        -0.5754795 0.01019830 -56.42895       0\n\nCodesummary(joint.fit1)[[2]]\n\n#>                                           Value     Std.Err     z-value\n#> marriedMarried/Partnered             0.08500617 0.114288096   0.7437885\n#> bc_pillsEver use BC pills            0.01416071 0.121381667   0.1166627\n#> children                             0.04127406 0.041453456   0.9956723\n#> bmi                                 -0.04618990 0.008902736  -5.1882812\n#> phys_act                            -0.02390457 0.031646769  -0.7553558\n#> factor(site)C                        0.28793318 0.191534397   1.5032975\n#> factor(site)M                        0.24565765 0.182353084   1.3471538\n#> factor(site)NJ                       0.50811192 0.413409657   1.2290761\n#> factor(site)P                        0.47082720 0.194236304   2.4239918\n#> factor(site)UCD                      0.15967019 0.237212326   0.6731109\n#> factor(site)UCLA                     0.30512524 0.241330294   1.2643470\n#> factor(ethnic)BLACK                 -0.37129333 0.144865054  -2.5630290\n#> factor(ethnic)CHINE                 -0.23664675 0.267794363  -0.8836883\n#> factor(ethnic)HISPA                 -1.09147761 0.503731229  -2.1667857\n#> factor(ethnic)JAPAN                 -0.06351346 0.239310601  -0.2654018\n#> factor(smoke)Past Only              -0.09355733 0.123965313  -0.7547057\n#> factor(smoke)Current Smoker         -0.07744957 0.162115759  -0.4777424\n#> factor(edu)Some College              0.28279048 0.149149159   1.8960246\n#> factor(edu)College degree or higher -0.02441751 0.146499443  -0.1666731\n#> factor(alcohol)<1/wk                 0.09482211 0.162431371   0.5837672\n#> factor(alcohol)1-7/wk                0.22221906 0.128025279   1.7357436\n#> factor(alcohol)>7/wk                 0.12459859 0.180614069   0.6898609\n#> factor(employed)Employed             0.01369358 0.136271876   0.1004872\n#> factor(health)Very Good             -0.04941036 0.131233116  -0.3765083\n#> factor(health)Good                  -0.05990930 0.155479382  -0.3853199\n#> factor(health)Fair/Poor             -0.10761417 0.202429102  -0.5316141\n#> Assoct                              -0.93144986 0.052866692 -17.6188413\n#> log(xi.1)                            0.60238627 0.518788894   1.1611395\n#> log(xi.2)                            1.34776023 0.504954758   2.6690713\n#> log(xi.3)                            1.62735769 0.502168303   3.2406619\n#> log(xi.4)                            1.78525209 0.500324993   3.5681849\n#> log(xi.5)                            1.97299001 0.500290051   3.9436923\n#> log(xi.6)                            2.13719246 0.495818142   4.3104362\n#> log(xi.7)                            2.23055592 0.497029334   4.4877752\n#>                                          p-value\n#> marriedMarried/Partnered            4.570045e-01\n#> bc_pillsEver use BC pills           9.071274e-01\n#> children                            3.194094e-01\n#> bmi                                 2.122439e-07\n#> phys_act                            4.500355e-01\n#> factor(site)C                       1.327623e-01\n#> factor(site)M                       1.779307e-01\n#> factor(site)NJ                      2.190433e-01\n#> factor(site)P                       1.535095e-02\n#> factor(site)UCD                     5.008768e-01\n#> factor(site)UCLA                    2.061055e-01\n#> factor(ethnic)BLACK                 1.037634e-02\n#> factor(ethnic)CHINE                 3.768645e-01\n#> factor(ethnic)HISPA                 3.025120e-02\n#> factor(ethnic)JAPAN                 7.907000e-01\n#> factor(smoke)Past Only              4.504256e-01\n#> factor(smoke)Current Smoker         6.328336e-01\n#> factor(edu)Some College             5.795679e-02\n#> factor(edu)College degree or higher 8.676273e-01\n#> factor(alcohol)<1/wk                5.593769e-01\n#> factor(alcohol)1-7/wk               8.260917e-02\n#> factor(alcohol)>7/wk                4.902816e-01\n#> factor(employed)Employed            9.199575e-01\n#> factor(health)Very Good             7.065390e-01\n#> factor(health)Good                  7.000004e-01\n#> factor(health)Fair/Poor             5.949933e-01\n#> Assoct                              1.765848e-69\n#> log(xi.1)                           2.455852e-01\n#> log(xi.2)                           7.606131e-03\n#> log(xi.3)                           1.192525e-03\n#> log(xi.4)                           3.594628e-04\n#> log(xi.5)                           8.023661e-05\n#> log(xi.6)                           1.629328e-05\n#> log(xi.7)                           7.197081e-06\n\nCode# summary(joint.fit.wei)"
  },
  {
    "objectID": "03_model_selection.html#model-selelction",
    "href": "03_model_selection.html#model-selelction",
    "title": "\n3  Model selection\n",
    "section": "\n3.1 Model selelction",
    "text": "3.1 Model selelction\n\nswan_amh0 is the longitudinal dataset\nswan_amh1 is the id dataset\n\n\nCodeload(\"data/swan_amh0.rda\")\nload(\"data/swan_amh1.rda\")"
  },
  {
    "objectID": "03_model_selection.html#backward-selection-of-vars",
    "href": "03_model_selection.html#backward-selection-of-vars",
    "title": "\n3  Model selection\n",
    "section": "\n3.2 Backward selection of vars",
    "text": "3.2 Backward selection of vars\nThe fitted model surv.fit16 from this 03_model_selection is the same as the surv.fit1 from `02_jm.qmd. Need to keep \\(site + ethnic + smoke + bmi\\).\nAll the variables:\n- surv outcomes: “etime” “event”. - lme outcomes: “log(amh)”\n\nlongitudinal vars:\n\n“id”\n“time”\n\n\nNot included into models:\n\n“age”\n“age0”\n“bmi_cat”\n“fmp_age”\n“parity”\n“phys_act”\n“start_time”\n“train”\n“visit”\n\n\nsurvival vars:\n\n\n“alcohol”,\n\n“bc_pills”,\n\n“bmi”,\n\n“children”,\n\n“edu”,\n\n“employed”,\n\n“ethnic”,\n\n“health”,\n\n“married”,\n\n“site”,\n“smoke”\n\n\n\n\nCode### Need to keep site + ethnic + smoke + bmi\n## testing for physical activity (taking out phys.act)\nsurv.fit11 <- coxph(Surv(etime, event) ~ married + bc_pills + children + bmi +\n                      factor(site) + factor(ethnic) + factor(smoke) +\n                      factor(edu) + factor(alcohol) + factor(employed) + factor(health),\n                    data = swan_amh1, \n                    x = TRUE, \n                    model = TRUE)\n\n## testing for employed\nsurv.fit12 <- coxph(Surv(etime, event) ~ married + bc_pills + children + bmi +\n                      factor(site) + factor(ethnic) + factor(smoke) +\n                      factor(edu) + factor(alcohol) + factor(health),\n                    data = swan_amh1, x = TRUE, model = TRUE)\n\n## testing for children\nsurv.fit13 <- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                      factor(site) + factor(ethnic) + factor(smoke) +\n                      factor(edu) + factor(alcohol) + factor(health),\n                    data = swan_amh1, x = TRUE, model = TRUE)\n\n\n## testing for edu (education)\nsurv.fit14 <- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                      factor(site) + factor(ethnic) + factor(smoke) +\n                      factor(alcohol) + factor(health),\n                    data = swan_amh1, \n                    x = TRUE,\n                    model = TRUE)\n\n\n## testing for alcohol\nsurv.fit15 <- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                      factor(site) + factor(ethnic) + factor(smoke) +\n                      factor(health),\n                    data = swan_amh1, \n                    x = TRUE,\n                    model = TRUE)\n\n\n## testing for health\nsurv.fit16 <- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                      factor(site) + factor(ethnic) + factor(smoke),\n                    data = swan_amh1, \n                    x = TRUE,\n                    model = TRUE)\n\n\n## testing for bc_pills\nsurv.fit17 <- coxph(Surv(etime, event) ~ married + bmi +\n                      factor(site) + factor(ethnic) + factor(smoke),\n                    data = swan_amh1, \n                    x = TRUE, \n                    model = TRUE)\n\n\n\nCodeoptions(digits = 4)\nrbind(fit11 = glance(surv.fit11), \n      fit12 = glance(surv.fit12), \n      fit13 = glance(surv.fit13),\n      fit14 = glance(surv.fit14),\n      fit15 = glance(surv.fit15),\n      fit16 = glance(surv.fit16),\n      fit17 = glance(surv.fit17)) %>%\n  mutate(name = c(\"fit11\", \"fit12\", \"fit13\",\n                  \"fit14\", \"fit15\", \"fit16\",\n                  \"fit17\"),\n         formula = c(surv.fit11$formula,\n                     surv.fit12$formula,\n                     surv.fit13$formula,\n                     surv.fit14$formula,\n                     surv.fit15$formula,\n                     surv.fit16$formula,\n                     surv.fit17$formula),\n         formula = as.character(formula)) %>%\n  dplyr::select(name, logLik, AIC, \n                BIC, r.squared, concordance, formula) \n\n\n\n  \n\n\n\nHere is the final survival sub-model.\n\nCodetidy(surv.fit16)\n\n\n\n  \n\n\n\nThe comparison is not exactly make sense to me, so need to talk with EJC for further works on the model. Backward model selection is not my favorite 😞 at all."
  },
  {
    "objectID": "03_model_selection.html#using-step-function",
    "href": "03_model_selection.html#using-step-function",
    "title": "\n3  Model selection\n",
    "section": "\n3.3 Using step function",
    "text": "3.3 Using step function\nThe results show there are extra variables we can include, if necessary. Here are the results using step function.\nThe selection with upper of the full model including all the variables, the lower of the null model with only the intercept.\n\nCodesurv.fit1 <- surv.fit16\nsurv.step <- step(surv.fit1, \n                  scope = list(upper = ~age + married + bc_pills + children + bmi +\n                                 factor(site) + factor(ethnic) + factor(smoke) +\n                                 factor(edu) + factor(alcohol) + factor(employed) +\n                                 factor(health),\n                               lower = ~ 1))\n\n#> Start:  AIC=6467.46\n#> Surv(etime, event) ~ married + bc_pills + bmi + factor(site) + \n#>     factor(ethnic) + factor(smoke)\n#> \n#>                    Df    AIC\n#> + age               1 6396.3\n#> - factor(ethnic)    4 6462.8\n#> - bmi               1 6465.7\n#> <none>                6467.5\n#> + factor(health)    3 6467.6\n#> - factor(site)      6 6468.6\n#> + children          1 6469.1\n#> + factor(employed)  1 6469.4\n#> + factor(edu)       2 6469.5\n#> - bc_pills          1 6470.6\n#> + factor(alcohol)   3 6470.6\n#> - married           1 6470.8\n#> - factor(smoke)     2 6480.8\n#> \n#> Step:  AIC=6396.32\n#> Surv(etime, event) ~ married + bc_pills + bmi + factor(site) + \n#>     factor(ethnic) + factor(smoke) + age\n#> \n#>                    Df    AIC\n#> - factor(ethnic)    4 6393.3\n#> + factor(health)    3 6393.4\n#> - bmi               1 6394.5\n#> <none>                6396.3\n#> - bc_pills          1 6397.9\n#> + factor(employed)  1 6398.0\n#> - factor(site)      6 6398.1\n#> + factor(edu)       2 6398.3\n#> + children          1 6398.3\n#> - married           1 6399.1\n#> + factor(alcohol)   3 6400.0\n#> - factor(smoke)     2 6408.6\n#> - age               1 6467.5\n#> \n#> Step:  AIC=6393.28\n#> Surv(etime, event) ~ married + bc_pills + bmi + factor(site) + \n#>     factor(smoke) + age\n#> \n#>                    Df    AIC\n#> - bmi               1 6391.8\n#> <none>                6393.3\n#> + factor(health)    3 6393.6\n#> - bc_pills          1 6394.9\n#> + children          1 6395.0\n#> + factor(employed)  1 6395.1\n#> + factor(edu)       2 6396.3\n#> + factor(ethnic)    4 6396.3\n#> - factor(site)      6 6396.5\n#> + factor(alcohol)   3 6396.5\n#> - married           1 6396.8\n#> - factor(smoke)     2 6403.7\n#> - age               1 6462.8\n#> \n#> Step:  AIC=6391.81\n#> Surv(etime, event) ~ married + bc_pills + factor(site) + factor(smoke) + \n#>     age\n#> \n#>                    Df    AIC\n#> <none>                6391.8\n#> + factor(health)    3 6392.8\n#> + bmi               1 6393.3\n#> + children          1 6393.4\n#> - bc_pills          1 6393.5\n#> + factor(employed)  1 6393.5\n#> + factor(ethnic)    4 6394.5\n#> + factor(alcohol)   3 6394.9\n#> + factor(edu)       2 6395.0\n#> - factor(site)      6 6395.2\n#> - married           1 6396.3\n#> - factor(smoke)     2 6402.4\n#> - age               1 6461.4\n\n\n\n3.3.1 step() selected “best” model\nHere are the final model from step() function, which is does not including the bmi and ethnic variables. However the age is included in the model.\nNeed to talk with EJC, I was not sure why do not include age into the survival model.\n\nCodeprint(surv.step$formula)\n\n#> Surv(etime, event) ~ married + bc_pills + factor(site) + factor(smoke) + \n#>     age\n\nCodetidy(surv.step)"
  },
  {
    "objectID": "03_model_selection.html#joint-model-with-jmsurvfitjm",
    "href": "03_model_selection.html#joint-model-with-jmsurvfitjm",
    "title": "\n3  Model selection\n",
    "section": "\n3.4 Joint model with JM::survfitJM()\n",
    "text": "3.4 Joint model with JM::survfitJM()\n\nHere is the joint model with\n\\(lme.fit1 \\sim (fixed = lamh \\sim time, \\ random = \\sim time| id)\\)\n\\(surv.fit1 \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(site) + factor(ethnic) + factor(smoke))\\)\nThis is the most basic form, no slope, on interaction, on integral functions. Also the original model, included in EJC’s notes (the model with only factor(ethnic) + factor(smoke), STILL does not allow for calc of AUC.)\n\nCode### the model with only factor(ethnic) + factor(smoke) \n### STILL does not allow for calc of AUC\nlme.fit1 <- lme(lamh ~ time, \n                data = swan_amh0, \n                random = ~ time|id)\n\n## joint model fit\njoint.fit1 <- jointModel(lme.fit1,\n                         surv.fit1,\n                         timeVar = \"time\", \n                         method = \"piecewise-PH-aGH\")\nsummary(joint.fit1)\n\n#> \n#> Call:\n#> jointModel(lmeObject = lme.fit1, survObject = surv.fit1, timeVar = \"time\", \n#>     method = \"piecewise-PH-aGH\")\n#> \n#> Data Descriptives:\n#> Longitudinal Process     Event Process\n#> Number of Observations: 3326 Number of Events: 600 (100%)\n#> Number of Groups: 600\n#> \n#> Joint Model Summary:\n#> Longitudinal Process: Linear mixed-effects model\n#> Event Process: Relative risk model with piecewise-constant\n#>      baseline risk function\n#> Parameterization: Time-dependent \n#> \n#>    log.Lik      AIC      BIC\n#>  -7332.592 14723.18 14850.69\n#> \n#> Variance Components:\n#>              StdDev    Corr\n#> (Intercept)  1.6032  (Intr)\n#> time         0.0343 -0.0856\n#> Residual     1.3030        \n#> \n#> Coefficients:\n#> Longitudinal Process\n#>               Value Std.Err  z-value p-value\n#> (Intercept)  7.8648  0.0983  80.0274 <0.0001\n#> time        -0.5750  0.0102 -56.4857 <0.0001\n#> \n#> Event Process\n#>                               Value Std.Err  z-value p-value\n#> marriedMarried/Partnered     0.1046  0.1086   0.9635  0.3353\n#> bc_pillsEver use BC pills    0.0461  0.1182   0.3900  0.6966\n#> bmi                         -0.0461  0.0083  -5.5319 <0.0001\n#> factor(site)C                0.2484  0.1853   1.3404  0.1801\n#> factor(site)M                0.2076  0.1751   1.1858  0.2357\n#> factor(site)NJ               0.4929  0.4129   1.1938  0.2326\n#> factor(site)P                0.4339  0.1873   2.3163  0.0205\n#> factor(site)UCD              0.0377  0.2312   0.1629  0.8706\n#> factor(site)UCLA             0.2987  0.2376   1.2575  0.2086\n#> factor(ethnic)BLACK         -0.3622  0.1378  -2.6279  0.0086\n#> factor(ethnic)CHINE         -0.2540  0.2529  -1.0044  0.3152\n#> factor(ethnic)HISPA         -1.0355  0.4859  -2.1310  0.0331\n#> factor(ethnic)JAPAN         -0.0771  0.2338  -0.3299  0.7414\n#> factor(smoke)Past Only      -0.0536  0.1211  -0.4424  0.6582\n#> factor(smoke)Current Smoker  0.0182  0.1574   0.1157  0.9079\n#> Assoct                      -0.9124  0.0507 -17.9923 <0.0001\n#> log(xi.1)                    0.5680  0.3779   1.5029        \n#> log(xi.2)                    1.3103  0.3592   3.6477        \n#> log(xi.3)                    1.5893  0.3560   4.4643        \n#> log(xi.4)                    1.7405  0.3513   4.9541        \n#> log(xi.5)                    1.9391  0.3522   5.5054        \n#> log(xi.6)                    2.1029  0.3511   5.9899        \n#> log(xi.7)                    2.1715  0.3459   6.2779        \n#> \n#> Integration:\n#> method: (pseudo) adaptive Gauss-Hermite\n#> quadrature points: 3 \n#> \n#> Optimization:\n#> Convergence: 0"
  },
  {
    "objectID": "03_model_selection.html#trying-stratified-baseline-hazard",
    "href": "03_model_selection.html#trying-stratified-baseline-hazard",
    "title": "\n3  Model selection\n",
    "section": "\n3.5 Trying stratified baseline hazard",
    "text": "3.5 Trying stratified baseline hazard\n\nOne is to include the other covariates (or multiple covariates) as regression terms for the hazard function.\nAlternatively, if the covariates we are adjusting for is categorical with a small number of levels \\(G\\), we may construct a stratified log-rank test.\n\nIf we stratify on event with strata() we get estimates of the effect of the covariates on events under the assumption that they affect both groups equally.\n\nCode# surv.fit1 <- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n#                       factor(site) + factor(ethnic) + factor(smoke),\n#                     data = swan_amh1, \n#                     x = TRUE,\n#                     model = TRUE)\n\nsurv.fit2 <- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                     strata(site) + strata(ethnic) + strata(smoke),\n                   data = swan_amh1,\n                   x = TRUE,\n                   model = TRUE)\n\n# anova(surv.fit1, surv.fit2)\n\n## joint model fit\njoint.fit2 <- jointModel(lme.fit1,\n                         surv.fit2,\n                         timeVar = \"time\",\n                         method = \"piecewise-PH-aGH\")\n# summary(joint.fit2)\n\n\n### only smoke as a strata\nsurv.fit3 <- coxph(Surv(etime, event) ~ married + bc_pills  + bmi  +\n                     strata(smoke) ,\n                  data = swan_amh1,\n                  x = TRUE,\n                  model = TRUE)\n# summary(surv.fit3)\n\n## joint model fit\njoint.fit3 <- jointModel(lme.fit1, \n                         surv.fit3,\n                         timeVar = \"time\",\n                         method = \"piecewise-PH-aGH\")\n\n\n\n3.5.1 Summary for Survival sub-models\n\nCodesurv.fit2\n\n#> Call:\n#> coxph(formula = Surv(etime, event) ~ married + bc_pills + bmi + \n#>     strata(site) + strata(ethnic) + strata(smoke), data = swan_amh1, \n#>     model = TRUE, x = TRUE)\n#> \n#>                                coef exp(coef)  se(coef)      z      p\n#> marriedMarried/Partnered   0.193505  1.213495  0.105891  1.827 0.0676\n#> bc_pillsEver use BC pills -0.263812  0.768118  0.108311 -2.436 0.0149\n#> bmi                       -0.009317  0.990726  0.007385 -1.262 0.2071\n#> \n#> Likelihood ratio test=11.22  on 3 df, p=0.01058\n#> n= 600, number of events= 600\n\nCodesummary(joint.fit2)[[2]]\n\n#>                                 Value     Std.Err     z-value      p-value\n#> marriedMarried/Partnered   0.10653622 0.106343402   1.0018132 3.164338e-01\n#> bc_pillsEver use BC pills  0.03254861 0.110711120   0.2939958 7.687611e-01\n#> bmi                       -0.05699208 0.007519614  -7.5791230 3.478986e-14\n#> Assoct                    -0.90227544 0.048728325 -18.5164470 1.521530e-76\n#> log(xi.1)                  0.90947411 0.325786841   2.7916232 5.244439e-03\n#> log(xi.2)                  1.64843965 0.308169879   5.3491264 8.837978e-08\n#> log(xi.3)                  1.91466278 0.305316339   6.2710787 3.585554e-10\n#> log(xi.4)                  2.06507118 0.302787502   6.8201995 9.091415e-12\n#> log(xi.5)                  2.24995839 0.306371473   7.3438900 2.074737e-13\n#> log(xi.6)                  2.40716838 0.304598942   7.9027470 2.728229e-15\n#> log(xi.7)                  2.45377514 0.307136142   7.9892100 1.358062e-15\n\n\n\nCodesurv.fit3\n\n#> Call:\n#> coxph(formula = Surv(etime, event) ~ married + bc_pills + bmi + \n#>     strata(smoke), data = swan_amh1, model = TRUE, x = TRUE)\n#> \n#>                                coef exp(coef)  se(coef)      z      p\n#> marriedMarried/Partnered   0.211912  1.236039  0.093244  2.273 0.0230\n#> bc_pillsEver use BC pills -0.236141  0.789670  0.095720 -2.467 0.0136\n#> bmi                       -0.005804  0.994212  0.006085 -0.954 0.3401\n#> \n#> Likelihood ratio test=13.45  on 3 df, p=0.003752\n#> n= 600, number of events= 600\n\nCodesummary(joint.fit3)[[2]]\n\n#>                                 Value     Std.Err     z-value      p-value\n#> marriedMarried/Partnered   0.10653622 0.106343402   1.0018132 3.164338e-01\n#> bc_pillsEver use BC pills  0.03254861 0.110711120   0.2939958 7.687611e-01\n#> bmi                       -0.05699208 0.007519614  -7.5791230 3.478986e-14\n#> Assoct                    -0.90227544 0.048728325 -18.5164470 1.521530e-76\n#> log(xi.1)                  0.90947411 0.325786841   2.7916232 5.244439e-03\n#> log(xi.2)                  1.64843965 0.308169879   5.3491264 8.837978e-08\n#> log(xi.3)                  1.91466278 0.305316339   6.2710787 3.585554e-10\n#> log(xi.4)                  2.06507118 0.302787502   6.8201995 9.091415e-12\n#> log(xi.5)                  2.24995839 0.306371473   7.3438900 2.074737e-13\n#> log(xi.6)                  2.40716838 0.304598942   7.9027470 2.728229e-15\n#> log(xi.7)                  2.45377514 0.307136142   7.9892100 1.358062e-15\n\n\n\n3.5.2 Checking Stratification\n\nCodesurvdiff(Surv(etime, event) ~ bc_pills, data = swan_amh1)\n\n#> Call:\n#> survdiff(formula = Surv(etime, event) ~ bc_pills, data = swan_amh1)\n#> \n#>                              N Observed Expected (O-E)^2/E (O-E)^2/V\n#> bc_pills=Never             155      155      137     2.361      3.09\n#> bc_pills=Ever use BC pills 445      445      463     0.699      3.09\n#> \n#>  Chisq= 3.1  on 1 degrees of freedom, p= 0.08\n\nCodesurvdiff(Surv(etime, event) ~ bc_pills + strata(site) + strata(ethnic) + strata(smoke),\n         data = swan_amh1)\n\n#> Call:\n#> survdiff(formula = Surv(etime, event) ~ bc_pills + strata(site) + \n#>     strata(ethnic) + strata(smoke), data = swan_amh1)\n#> \n#>                              N Observed Expected (O-E)^2/E (O-E)^2/V\n#> bc_pills=Never             155      155      134     3.165      5.33\n#> bc_pills=Ever use BC pills 445      445      466     0.913      5.33\n#> \n#>  Chisq= 5.3  on 1 degrees of freedom, p= 0.02\n\nCodesurvdiff(Surv(etime, event) ~ married, data = swan_amh1)\n\n#> Call:\n#> survdiff(formula = Surv(etime, event) ~ married, data = swan_amh1)\n#> \n#>                                 N Observed Expected (O-E)^2/E (O-E)^2/V\n#> married=Not Married/Partnered 191      191      218      3.29       5.3\n#> married=Married/Partnered     409      409      382      1.87       5.3\n#> \n#>  Chisq= 5.3  on 1 degrees of freedom, p= 0.02\n\nCodesurvdiff(Surv(etime, event) ~ married + strata(site) + strata(ethnic) + strata(smoke),\n         data = swan_amh1)\n\n#> Call:\n#> survdiff(formula = Surv(etime, event) ~ married + strata(site) + \n#>     strata(ethnic) + strata(smoke), data = swan_amh1)\n#> \n#>                                 N Observed Expected (O-E)^2/E (O-E)^2/V\n#> married=Not Married/Partnered 191      191      211      1.85      4.03\n#> married=Married/Partnered     409      409      389      1.00      4.03\n#> \n#>  Chisq= 4  on 1 degrees of freedom, p= 0.04\n\n\n\nCodetidy(surv.fit1) \n\n\n\n  \n\n\nCodetidy(surv.fit2) \n\n\n\n  \n\n\nCodetidy(surv.fit3)"
  },
  {
    "objectID": "03_model_selection.html#obtaining-dynamic-predictions",
    "href": "03_model_selection.html#obtaining-dynamic-predictions",
    "title": "\n3  Model selection\n",
    "section": "\n3.6 Obtaining dynamic predictions",
    "text": "3.6 Obtaining dynamic predictions\nThis function accepts as main arguments a fitted joint model and a data frame that contains the longitudinal and covariate information for the subjects for which we wish to calculate the predicted survival probabilities.\n\nCodeids <- unique(swan_amh0$id)\n## length(ids)\n## Prediction for the survival outcomes\nND1 <- swan_amh0[swan_amh0$id == ids[8], ] ## 4, 5, 7 (not so good)\nsfit <- JM::survfitJM(joint.fit3,\n                      newdata = ND1, \n                      idVar = \"id\") \n\n\n\nCodeND1\n\n\n\n  \n\n\nCode# subset(ND1, \n#        select = c('id', 'age0', 'time', \n#                   'start_time', \n#                   'etime', 'amh'))\n#                   \n\nsfit$summaries$`1100390` %>% as.data.frame()\n\n\n\n  \n\n\nCodeid1100390 <- filter(swan_amh0, id == ids[5]) %>%\n  dplyr::select(etime, lamh)\n\n\n\nCodeplot(sfit, estimator = \"mean\", \n     include.y = TRUE, \n     conf.int = TRUE, \n     fill.area = TRUE,\n     col.area = \"lightgrey\")\n\n\n\n\n\n3.6.1 AUC and ROC\nI can only pullout the AUC for certain models, not all of them. The ROC function gets problems too. There is also on function for Brier Score in JM package.\n\nCode## Tstart is the time up which long measurements are used in the predictions\n## Dt = is the window of time that will be considered for predictions;\n## discrimination is calculated based on this window\nauc2.t3 <- try(JM::aucJM(joint.fit2,\n                     newdata = swan_amh0,\n                     idVar = \"id\",\n                     Tstart = 5,\n                     Dt = 3))\n\n#> Error in eval(attr(TermsT, \"variables\"), data.id)[[kk]] : \n#>   recursive indexing failed at level 2\n\nCodeauc2.t3\n\n#> [1] \"Error in eval(attr(TermsT, \\\"variables\\\"), data.id)[[kk]] : \\n  recursive indexing failed at level 2\\n\\n\"\n#> attr(,\"class\")\n#> [1] \"try-error\"\n#> attr(,\"condition\")\n#> <simpleError in eval(attr(TermsT, \"variables\"), data.id)[[kk]]: recursive indexing failed at level 2\n#> >\n\nCodeauc1 <- JM::aucJM(joint.fit3,\n                  newdata = swan_amh0,\n                  idVar = \"id\",\n                  Tstart = 5,\n                  Dt = 3) ##\n\nauc2 <- try(JM::aucJM(joint.fit3, \n                  newdata = swan_amh0,\n                  idVar = \"id\",\n                  Tstart = 5,\n                  Dt = 3)) \nauc2\n\n#> \n#>  Time-dependent AUC for the Cox Model joint.fit3\n#> \n#> Estimated AUC: 0.8774\n#> At time: 8\n#> Using information up to time: 5 (407 subjects still at risk)"
  },
  {
    "objectID": "03_model_selection.html#time-dependent-slopes-parameterization",
    "href": "03_model_selection.html#time-dependent-slopes-parameterization",
    "title": "\n3  Model selection\n",
    "section": "\n3.7 Time-Dependent Slopes Parameterization",
    "text": "3.7 Time-Dependent Slopes Parameterization\nHowever, since for each patient the marker follows a trajectory in time, it is also reasonable to consider parameterizations that allow the risk for an event to also depend on other features of this trajectory. A parameterization of this type has been considered by Ye et al. (2008b) who postulated a joint model in which the risk depends on both the current true value of the trajectory and the slope of the true trajectory at time t.\n\\[\n\\begin{split}\n  h_i(t) & = h_0(t) \\exp\\{\\gamma^{\\top}w_i + \\alpha_1 m_i(t) + \\alpha_2 m'_i(t)\\}\\\\\n  m'_i(t) & = \\frac {d} {dt} m_i(t) = \\frac {d} {dt} \\{ x^{\\top}_i (t) \\beta + z_i^{\\top} (t) b_i \\}\\\\\n  m'_i(t) & = [x_i^{slope}(t)]^{\\top} \\beta^{slope} + [z_i^{slope}(t)]^{\\top} b_i^{slope}\n\\end{split}\n\\]\n\nIncluding the interaction term in the cox-model for \\(m_i\\)\n\nThe time variable needs to be nonlinear for the longitudinal data\n\nso I included the I(time^2) term in the lme model\n\n\n\n\nCodecontrol <- lmeControl(opt = \"optim\")\n\nlme.fit2 <- lme(lamh ~ time + I(time^2), \n                data = swan_amh0, \n                control = control,\n                random = ~ time| id)\n\nlme.fit3 <- lme(lamh ~ time + I(time^2), \n                data = swan_amh0, \n                control = control,\n                random = ~ time + I(time^2) | id)\n\nrbind(glance(lme.fit1), \n      glance(lme.fit2), \n      glance(lme.fit3))\n\n\n\n  \n\n\n\n\nCodejm.fit21 <- jointModel(lme.fit2,\n                       surv.fit1,\n                       timeVar = \"time\",\n                       method = \"piecewise-PH-aGH\")\n\njm.fit31 <- jointModel(lme.fit3,\n                       surv.fit1,\n                       timeVar = \"time\",\n                       method = \"piecewise-PH-aGH\")\n\n# jm.fit22 <- jointModel(lme.fit2,\n#                        surv.fit2,\n#                        timeVar = \"time\",\n#                        # interFact = list(value = ~ age,\n#                        #                  ##  a named list with a component named value\n#                        #                  ##  that provides an R formula specifying the\n#                        #                  ##  form of the W2 design matrix\n#                        #                  data = swan_amh1),\n#                        method = \"piecewise-PH-aGH\")\n\n# jm.fit32 <- jointModel(lme.fit3,\n#                        surv.fit2,\n#                        timeVar = \"time\",\n#                        method = \"piecewise-PH-aGH\")\n\n\n\nCode# model.matrix(lamh ~ time + I(time^2), \n#                 data = swan_amh0)\ndform2 <- list(fixed = ~ I(2 * time),\n              ## the 2nd and 3rd fixed effects of mi(t) used\n              indFixed = 2:3, \n              random = ~ 1, \n              ## the second random effect of mi(t)\n              indRandom = 2)\ndform3 <- list(fixed = ~ I(2 * time),\n              ## the 2nd and 3rd fixed effects of mi(t) used\n              indFixed = 2:3, \n              random = ~ I(2 * time), \n              ## the second and third random effect of mi(t)\n              indRandom = 2:3)\n\n\nWarning: Stop time must be > start time, NA created\n\nCodejm.fit21d <- update(jm.fit21,\n                    parameterization = \"both\",\n                    derivForm = dform2)\n\njm.fit31d <- update(jm.fit31,\n                    parameterization = \"both\",\n                    derivForm = dform3)\n\n\n\n3.7.1 Here is the summarization of the models\n\\(lme.fit2 \\sim (fixed = lamh \\sim time + I(time^2), \\ random = \\sim time| id)\\)\n\\(surv.fit1 \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(site) + factor(ethnic) + factor(smoke))\\)\n\nCodesummary(jm.fit21d)\n\n#> Warning in sqrt(diag(VarCov[indY, indY])): NaNs produced\n\n\n#> Warning in sqrt(diag(VarCov[indT, indT])): NaNs produced\n\n\n#> \n#> Call:\n#> jointModel(lmeObject = lme.fit2, survObject = surv.fit1, timeVar = \"time\", \n#>     parameterization = \"both\", method = \"piecewise-PH-aGH\", derivForm = dform2)\n#> \n#> Data Descriptives:\n#> Longitudinal Process     Event Process\n#> Number of Observations: 3326 Number of Events: 600 (100%)\n#> Number of Groups: 600\n#> \n#> Joint Model Summary:\n#> Longitudinal Process: Linear mixed-effects model\n#> Event Process: Relative risk model with piecewise-constant\n#>      baseline risk function\n#> Parameterization: Time-dependent + time-dependent slope \n#> \n#>    log.Lik      AIC      BIC\n#>  -7313.277 14688.55 14824.86\n#> \n#> Variance Components:\n#>              StdDev    Corr\n#> (Intercept)  1.2758  (Intr)\n#> time         0.0612  0.8267\n#> Residual     1.2815        \n#> \n#> Coefficients:\n#> Longitudinal Process\n#>               Value Std.Err z-value p-value\n#> (Intercept)  7.5380     NaN     NaN     NaN\n#> time        -0.4435     NaN     NaN     NaN\n#> I(time^2)   -0.0110     NaN     NaN     NaN\n#> \n#> Event Process\n#>                               Value Std.Err z-value p-value\n#> marriedMarried/Partnered     0.0748  0.1117  0.6693  0.5033\n#> bc_pillsEver use BC pills    0.0672  0.1223  0.5494  0.5827\n#> bmi                         -0.0495  0.0084 -5.8599 <0.0001\n#> factor(site)C                0.2083  0.1960  1.0630  0.2878\n#> factor(site)M                0.1350  0.1828  0.7384  0.4603\n#> factor(site)NJ               0.7308  0.4293  1.7024  0.0887\n#> factor(site)P                0.4094  0.1985  2.0622  0.0392\n#> factor(site)UCD             -0.0522  0.2344 -0.2227  0.8238\n#> factor(site)UCLA             0.1448  0.2507  0.5775  0.5636\n#> factor(ethnic)BLACK         -0.3604  0.1445 -2.4933  0.0127\n#> factor(ethnic)CHINE         -0.2401  0.2495 -0.9625  0.3358\n#> factor(ethnic)HISPA         -1.6574  0.5114 -3.2410  0.0012\n#> factor(ethnic)JAPAN          0.0151  0.2420  0.0624  0.9502\n#> factor(smoke)Past Only      -0.1135  0.1261 -0.9001  0.3681\n#> factor(smoke)Current Smoker -0.0519  0.1623 -0.3199  0.7490\n#> Assoct                      -1.2355     NaN     NaN     NaN\n#> Assoct.s                    12.8634     NaN     NaN     NaN\n#> log(xi.1)                    9.7435     NaN     NaN        \n#> log(xi.2)                   10.5641     NaN     NaN        \n#> log(xi.3)                   10.8616     NaN     NaN        \n#> log(xi.4)                   11.0145     NaN     NaN        \n#> log(xi.5)                   11.2383     NaN     NaN        \n#> log(xi.6)                   11.4215     NaN     NaN        \n#> log(xi.7)                   11.4962     NaN     NaN        \n#> \n#> Integration:\n#> method: (pseudo) adaptive Gauss-Hermite\n#> quadrature points: 3 \n#> \n#> Optimization:\n#> Convergence: 0\n\n\n\\(lme.fit3 \\sim (fixed = lamh \\sim time + I(time^2), \\ random = \\sim time + I(time^2)| id)\\)\n\\(surv.fit1 \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(site) + factor(ethnic) + factor(smoke))\\)\n\nCodesummary(jm.fit31d)\n\n#> \n#> Call:\n#> jointModel(lmeObject = lme.fit3, survObject = surv.fit1, timeVar = \"time\", \n#>     parameterization = \"both\", method = \"piecewise-PH-aGH\", derivForm = dform3)\n#> \n#> Data Descriptives:\n#> Longitudinal Process     Event Process\n#> Number of Observations: 3326 Number of Events: 600 (100%)\n#> Number of Groups: 600\n#> \n#> Joint Model Summary:\n#> Longitudinal Process: Linear mixed-effects model\n#> Event Process: Relative risk model with piecewise-constant\n#>      baseline risk function\n#> Parameterization: Time-dependent + time-dependent slope \n#> \n#>   log.Lik      AIC      BIC\n#>  -6783.88 13635.76 13785.26\n#> \n#> Variance Components:\n#>              StdDev    Corr        \n#> (Intercept)  1.1617  (Intr)    time\n#> time         0.1238  0.9994        \n#> I(time^2)    0.0130 -0.7498 -0.7416\n#> Residual     1.1466                \n#> \n#> Coefficients:\n#> Longitudinal Process\n#>               Value Std.Err  z-value p-value\n#> (Intercept)  6.6209  0.0963  68.7421 <0.0001\n#> time        -0.2108  0.0283  -7.4516 <0.0001\n#> I(time^2)   -0.0246  0.0019 -12.6315 <0.0001\n#> \n#> Event Process\n#>                               Value Std.Err  z-value p-value\n#> marriedMarried/Partnered     0.0270  0.1014   0.2666  0.7898\n#> bc_pillsEver use BC pills   -0.0006  0.1089  -0.0054  0.9957\n#> bmi                         -0.0366  0.0077  -4.7461 <0.0001\n#> factor(site)C                0.2269  0.1648   1.3763  0.1687\n#> factor(site)M                0.2557  0.1561   1.6379  0.1014\n#> factor(site)NJ               0.7520  0.5967   1.2604  0.2075\n#> factor(site)P                0.4415  0.1709   2.5829  0.0098\n#> factor(site)UCD              0.0548  0.2054   0.2668  0.7896\n#> factor(site)UCLA             0.4208  0.2106   1.9977  0.0458\n#> factor(ethnic)BLACK         -0.3204  0.1236  -2.5912  0.0096\n#> factor(ethnic)CHINE         -0.0400  0.2277  -0.1756  0.8606\n#> factor(ethnic)HISPA         -0.7663  0.6588  -1.1633  0.2447\n#> factor(ethnic)JAPAN         -0.0896  0.2092  -0.4281  0.6686\n#> factor(smoke)Past Only      -0.0870  0.1110  -0.7839  0.4331\n#> factor(smoke)Current Smoker  0.1030  0.1460   0.7056  0.4804\n#> Assoct                      -0.7625  0.0384 -19.8831 <0.0001\n#> Assoct.s                     0.0229  0.2824   0.0813  0.9352\n#> log(xi.1)                   -0.0747  0.3832  -0.1950        \n#> log(xi.2)                    0.7755  0.3914   1.9815        \n#> log(xi.3)                    0.9411  0.4012   2.3455        \n#> log(xi.4)                    0.9791  0.4057   2.4136        \n#> log(xi.5)                    1.0988  0.4138   2.6554        \n#> log(xi.6)                    1.2005  0.4169   2.8797        \n#> log(xi.7)                    1.2286  0.4203   2.9232        \n#> \n#> Integration:\n#> method: (pseudo) adaptive Gauss-Hermite\n#> quadrature points: 3 \n#> \n#> Optimization:\n#> Convergence: 0\n\n\nThe model with slope term is better than the model without slope term\n\n3.7.2 Comparision for jm.fit21 and jm.fit21d\n\nCodeanova(jm.fit21, jm.fit21d, process = \"Event\")\n\n#> \n#>                AIC      BIC  log.Lik    LRT df p.value\n#> jm.fit21  14865.88 14997.78 -7402.94                  \n#> jm.fit21d 14688.55 14824.86 -7313.28 179.32  1 <0.0001\n\n\n\n3.7.3 Comparision for jm.fit31 and jm.fit31d\n\nCodeanova(jm.fit31, jm.fit31d, process = \"Event\")\n\n#> \n#>                AIC      BIC  log.Lik  LRT df p.value\n#> jm.fit31  13636.58 13781.68 -6785.29                \n#> jm.fit31d 13635.76 13785.26 -6783.88 2.82  1  0.0929\n\n\n\n3.7.4 Comparision for jm.fit21d and jm.fit31d\n\nCodeanova(jm.fit21d, jm.fit31d)\n\n#> \n#>                AIC      BIC  log.Lik     LRT df p.value\n#> jm.fit21d 14688.55 14824.86 -7313.28                   \n#> jm.fit31d 13635.76 13785.26 -6783.88 1058.79  3 <0.0001"
  },
  {
    "objectID": "04_jmbayes.html#setting-up-for-linear-mixed-model",
    "href": "04_jmbayes.html#setting-up-for-linear-mixed-model",
    "title": "\n4  JMBayes\n",
    "section": "\n4.1 Setting up for linear mixed model",
    "text": "4.1 Setting up for linear mixed model\nBecause we are gonna use the JMbayes package and include the slope terms for the joint model, we need to fit the linear mixed model with the non-linear terms terms: including both the fixed and random terms.\nThe survival sub-models are directly from early work in R/03_model_selection.qmd. The survival sub-models used either factorized or stratified variables.\n\nCodeload(\"data/swan_amh0.rda\")\nload(\"data/swan_amh1.rda\")\n\n\n\ncontrol = lmeControl(opt = \"optim\")\nlme.fit1 &lt;- lme(lamh ~ time,\n                data = swan_amh0,\n                control = control,\n                random = ~ time| id)\n\nlme.fit2 &lt;- lme(lamh ~ time + I(time^2),\n                data = swan_amh0,\n                control = control,\n                random = ~ time| id)\n\nlme.fit3 &lt;- lme(lamh ~ time + I(time^2),\n                data = swan_amh0,\n                control = control,\n                random = ~ time + I(time^2) | id)\n\nsurv.fit1 &lt;- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                      factor(site) + factor(ethnic) + factor(smoke),\n                    data = swan_amh1,\n                    x = TRUE,\n                    model = TRUE)\n\nsurv.fit2 &lt;- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                     strata(site) + strata(ethnic) + strata(smoke),\n                   data = swan_amh1,\n                   x = TRUE,\n                   model = TRUE)"
  },
  {
    "objectID": "04_jmbayes.html#using-jmbayesjointmodel",
    "href": "04_jmbayes.html#using-jmbayesjointmodel",
    "title": "\n4  JMBayes\n",
    "section": "\n4.2 Using JMBayes::jointModel()\n",
    "text": "4.2 Using JMBayes::jointModel()\n\nJMbayes is more flexible (in some respects):\n\ndirectly implements the MCMC\nallows for categorical longitudinal data as well\nallows for general transformation functions\npenalized B-splines for the baseline hazard function\n\nBoth package give options to define the aforementioned association structures\n\nin JM via arguments parameterization & derivForm\nin JMbayes via arguments param & extraForm\n\nHow did we name the models, package used + .fit + lmm model number + surv model number + extensions"
  },
  {
    "objectID": "04_jmbayes.html#jmbayes1-models",
    "href": "04_jmbayes.html#jmbayes1-models",
    "title": "\n4  JMBayes\n",
    "section": "\n4.3 JMbayes1 models",
    "text": "4.3 JMbayes1 models\nThe parameters in JMbayes and JMbayes2 are different, The dform also need to be chanaged accordingly.\nJMbayes::jointModelBayes(lmeObject, \n                         survObject, \n                         timeVar,  \n                         param = c(\"td-value\", \"td-extra\", \n                                   \"td-both\", \"shared-betasRE\",\n                                   \"shared-RE\"), \n                         extraForm = NULL,\n                         baseHaz = c(\"P-splines\", \"regression-splines\"),\n                         ...)\n\nJMbayes2::jm(Surv_object,\n             Mixed_objects,\n             time_var, \n             recurrent = FALSE,\n             functional_forms = NULL, \n             data_Surv = NULL, \n             id_var = NULL, \n             control = NULL,\n             ...)\n\nCodejmbayes.fit11 &lt;- JMbayes::jointModelBayes(lme.fit1,\n                                          surv.fit1,\n                                          timeVar = \"time\",\n                                          # time_var = \"time\",\n                                          seed = 55555)\njmbayes.fit12 &lt;- JMbayes::jointModelBayes(lme.fit1,\n                                          surv.fit2,\n                                          timeVar = \"time\",\n                                          seed = 55555)\njmbayes.fit31 &lt;- JMbayes::jointModelBayes(lme.fit3,\n                                          surv.fit1,\n                                          timeVar = \"time\",\n                                          seed = 55555)\n\njm1.dform3 &lt;- list(fixed = ~ 0 + dns(time, 2),\n              ## the 2nd and 3rd fixed effects of mi(t) used\n              indFixed = 2:3,\n              random = ~ 0 + dns(time, 2),\n              ## the second and third random effect of mi(t)\n              indRandom = 2:3)\n\njmbayes.fit31.d &lt;- update(jmbayes.fit31,\n                         param = \"td-both\",\n                         extraForm = jm1.dform3,\n                         seed = 55555,\n                         n.iter = 35000)"
  },
  {
    "objectID": "04_jmbayes.html#summary-of-the-models",
    "href": "04_jmbayes.html#summary-of-the-models",
    "title": "\n4  JMBayes\n",
    "section": "\n4.4 Summary of the models",
    "text": "4.4 Summary of the models\n\n4.4.1 jmbayes.fit11\n\\(lme.fit1 \\sim (fixed = lamh \\sim time, \\ random = \\sim time| id)\\)\n\\(surv.fit1 \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(site) + factor(ethnic) + factor(smoke))\\)\n\nCodesummary(jmbayes.fit11)\n\n#&gt; \n#&gt; Call:\n#&gt; JMbayes::jointModelBayes(lmeObject = lme.fit1, survObject = surv.fit1, \n#&gt;     timeVar = \"time\", seed = 55555)\n#&gt; \n#&gt; Data Descriptives:\n#&gt; Longitudinal Process     Event Process\n#&gt; Number of Observations: 3326 Number of Events: 600 (100%)\n#&gt; Number of subjects: 600\n#&gt; \n#&gt; Joint Model Summary:\n#&gt; Longitudinal Process: Linear mixed-effects model\n#&gt; Event Process: Relative risk model with penalized-spline-approximated \n#&gt;      baseline risk function\n#&gt; Parameterization: Time-dependent value \n#&gt; \n#&gt;  LPML      DIC       pD\n#&gt;  -Inf 17823.75 1326.662\n#&gt; \n#&gt; Variance Components:\n#&gt;              StdDev    Corr\n#&gt; (Intercept)  1.7539  (Intr)\n#&gt; time         0.6806 -0.2079\n#&gt; Residual     1.2987        \n#&gt; \n#&gt; Coefficients:\n#&gt; Longitudinal Process\n#&gt;               Value Std.Err Std.Dev    2.5%   97.5%      P\n#&gt; (Intercept)  7.8910  0.0081  0.0981  7.7072  8.0852 &lt;0.001\n#&gt; time        -0.6334  0.0009  0.0295 -0.6905 -0.5751 &lt;0.001\n#&gt; \n#&gt; Event Process\n#&gt;                               Value Std.Err Std.Dev    2.5%   97.5%      P\n#&gt; marriedMarried/Partnered     0.1238  0.0110  0.1227 -0.1087  0.3678  0.318\n#&gt; bc_pillsEver use BC pills   -0.0410  0.0133  0.1412 -0.3243  0.2282  0.781\n#&gt; bmi                         -0.0350  0.0010  0.0078 -0.0516 -0.0205 &lt;0.001\n#&gt; factor(site)C                0.1837  0.0187  0.2128 -0.2418  0.6079  0.379\n#&gt; factor(site)M                0.3097  0.0199  0.2062 -0.1229  0.6951  0.157\n#&gt; factor(site)NJ               0.5245  0.0529  0.5369 -0.5228  1.5449  0.324\n#&gt; factor(site)P                0.4799  0.0208  0.2272  0.0451  0.9387  0.027\n#&gt; factor(site)UCD              0.1726  0.0203  0.2454 -0.3383  0.6187  0.474\n#&gt; factor(site)UCLA             0.5117  0.0278  0.2866 -0.0701  1.0699  0.081\n#&gt; factor(ethnic)BLACK         -0.2400  0.0116  0.1487 -0.5338  0.0623  0.112\n#&gt; factor(ethnic)CHINE         -0.0335  0.0244  0.2788 -0.5485  0.5568  0.886\n#&gt; factor(ethnic)HISPA         -0.2989  0.0731  0.6988 -1.6001  1.0534  0.670\n#&gt; factor(ethnic)JAPAN         -0.1291  0.0231  0.2620 -0.6075  0.3688  0.621\n#&gt; factor(smoke)Past Only       0.0317  0.0164  0.1616 -0.2952  0.3457  0.852\n#&gt; factor(smoke)Current Smoker  0.2369  0.0196  0.1935 -0.1427  0.6204  0.192\n#&gt; Assoct                      -0.6268  0.0021  0.0497 -0.7240 -0.5278 &lt;0.001\n#&gt; tauBs                        4.8146  1.7435  6.0547  0.7956 22.9612     NA\n#&gt; \n#&gt; MCMC summary:\n#&gt; iterations: 20000 \n#&gt; adapt: 3000 \n#&gt; burn-in: 3000 \n#&gt; thinning: 10 \n#&gt; time: 1.6 min\n\n\n\n4.4.2 jmbayes.fit21\n\\(lme.fit2 \\sim (fixed = lamh \\sim time + I(time^2), \\ random = \\sim time| id)\\)\n\\(surv.fit1 \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(site) + factor(ethnic) + factor(smoke))\\)\n\nCodesummary(jmbayes.fit12)\n\n#&gt; \n#&gt; Call:\n#&gt; JMbayes::jointModelBayes(lmeObject = lme.fit1, survObject = surv.fit2, \n#&gt;     timeVar = \"time\", seed = 55555)\n#&gt; \n#&gt; Data Descriptives:\n#&gt; Longitudinal Process     Event Process\n#&gt; Number of Observations: 3326 Number of Events: 600 (100%)\n#&gt; Number of subjects: 600\n#&gt; \n#&gt; Joint Model Summary:\n#&gt; Longitudinal Process: Linear mixed-effects model\n#&gt; Event Process: Relative risk model with penalized-spline-approximated \n#&gt;      baseline risk function\n#&gt; Parameterization: Time-dependent value \n#&gt; \n#&gt;  LPML     DIC       pD\n#&gt;  -Inf 17861.1 1329.203\n#&gt; \n#&gt; Variance Components:\n#&gt;              StdDev    Corr\n#&gt; (Intercept)  1.7724  (Intr)\n#&gt; time         0.6820 -0.2154\n#&gt; Residual     1.2975        \n#&gt; \n#&gt; Coefficients:\n#&gt; Longitudinal Process\n#&gt;               Value Std.Err Std.Dev    2.5%   97.5%      P\n#&gt; (Intercept)  7.9053  0.0091  0.1029  7.7142  8.1058 &lt;0.001\n#&gt; time        -0.6353  0.0011  0.0296 -0.6930 -0.5779 &lt;0.001\n#&gt; \n#&gt; Event Process\n#&gt;                             Value Std.Err Std.Dev    2.5%    97.5%      P\n#&gt; marriedMarried/Partnered   0.1584  0.0108  0.1305 -0.1015   0.4009  0.246\n#&gt; bc_pillsEver use BC pills -0.0260  0.0078  0.1258 -0.2709   0.2263  0.824\n#&gt; bmi                       -0.0404  0.0014  0.0087 -0.0584  -0.0246 &lt;0.001\n#&gt; Assoct                    -0.6269  0.0021  0.0495 -0.7254  -0.5307 &lt;0.001\n#&gt; tauBs                     35.4798  8.8402 45.3903  5.3019 165.7564     NA\n#&gt; \n#&gt; MCMC summary:\n#&gt; iterations: 20000 \n#&gt; adapt: 3000 \n#&gt; burn-in: 3000 \n#&gt; thinning: 10 \n#&gt; time: 1.6 min\n\n\n\n4.4.3 jmbayes.fit31\n\\(lme.fit3 \\sim (fixed = lamh \\sim time + I(time^2), \\ random = \\sim time + I(time^2) | id)\\)\n\\(surv.fit1 \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(site) + factor(ethnic) + factor(smoke))\\)\n\nCodesummary(jmbayes.fit31)\n\n#&gt; \n#&gt; Call:\n#&gt; JMbayes::jointModelBayes(lmeObject = lme.fit3, survObject = surv.fit1, \n#&gt;     timeVar = \"time\", seed = 55555)\n#&gt; \n#&gt; Data Descriptives:\n#&gt; Longitudinal Process     Event Process\n#&gt; Number of Observations: 3326 Number of Events: 600 (100%)\n#&gt; Number of subjects: 600\n#&gt; \n#&gt; Joint Model Summary:\n#&gt; Longitudinal Process: Linear mixed-effects model\n#&gt; Event Process: Relative risk model with penalized-spline-approximated \n#&gt;      baseline risk function\n#&gt; Parameterization: Time-dependent value \n#&gt; \n#&gt;  LPML          DIC           pD\n#&gt;  -Inf 2.500633e+46 1.250317e+46\n#&gt; \n#&gt; Variance Components:\n#&gt;              StdDev    Corr        \n#&gt; (Intercept)  2.6988  (Intr)    time\n#&gt; time         1.6955 -0.5082        \n#&gt; I(time^2)    9.7013  0.0168  0.1373\n#&gt; Residual     1.3745                \n#&gt; \n#&gt; Coefficients:\n#&gt; Longitudinal Process\n#&gt;               Value Std.Err Std.Dev    2.5%  97.5%      P\n#&gt; (Intercept)  6.3006  0.0098  0.1243  6.0628 6.5500 &lt;0.001\n#&gt; time         0.1093  0.0067  0.0873 -0.0516 0.2915  0.197\n#&gt; I(time^2)   -0.0891  0.0085  0.3974 -0.8420 0.6889  0.795\n#&gt; \n#&gt; Event Process\n#&gt;                               Value Std.Err Std.Dev    2.5%   97.5%      P\n#&gt; marriedMarried/Partnered     0.2543  0.0241  0.2431 -0.2502  0.7396  0.247\n#&gt; bc_pillsEver use BC pills   -0.1457  0.0244  0.2497 -0.6583  0.3538  0.496\n#&gt; bmi                          0.0040  0.0037  0.0209 -0.0377  0.0460  0.842\n#&gt; factor(site)C                0.2822  0.0420  0.4165 -0.5213  1.2297  0.444\n#&gt; factor(site)M                0.4022  0.0442  0.4228 -0.5628  1.2518  0.250\n#&gt; factor(site)NJ              -0.0470  0.1333  1.0991 -2.3788  2.0264  0.983\n#&gt; factor(site)P                0.5111  0.0516  0.4295 -0.3729  1.2928  0.208\n#&gt; factor(site)UCD              0.3317  0.0619  0.5006 -0.7142  1.3445  0.476\n#&gt; factor(site)UCLA             0.5128  0.0605  0.5311 -0.6173  1.5697  0.280\n#&gt; factor(ethnic)BLACK         -0.1436  0.0290  0.2907 -0.6715  0.5330  0.502\n#&gt; factor(ethnic)CHINE          0.1077  0.0422  0.4536 -0.7567  1.0956  0.816\n#&gt; factor(ethnic)HISPA         -1.1568  0.1954  1.4755 -4.2141  1.6407  0.354\n#&gt; factor(ethnic)JAPAN         -0.1257  0.0516  0.5052 -1.1879  0.8293  0.782\n#&gt; factor(smoke)Past Only       0.0861  0.0325  0.2766 -0.4473  0.6337  0.727\n#&gt; factor(smoke)Current Smoker  0.5389  0.0293  0.3146 -0.0902  1.1649  0.088\n#&gt; Assoct                      -0.1399  0.0042  0.0787 -0.3056 -0.0281 &lt;0.001\n#&gt; tauBs                        0.9066  0.1698  0.5279  0.2784  2.2966     NA\n#&gt; \n#&gt; MCMC summary:\n#&gt; iterations: 20000 \n#&gt; adapt: 3000 \n#&gt; burn-in: 3000 \n#&gt; thinning: 10 \n#&gt; time: 1.7 min\n\n\n\n4.4.4 jmbayes.fit31.d\n\\(lme.fit3 \\sim (fixed = lamh \\sim time + I(time^2), \\ random = \\sim time + I(time^2) | id)\\)\n\\(surv.fit1 \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(site) + factor(ethnic) + factor(smoke))\\)\n\nCodesummary(jmbayes.fit31.d)\n\n#&gt; \n#&gt; Call:\n#&gt; JMbayes::jointModelBayes(lmeObject = lme.fit3, survObject = surv.fit1, \n#&gt;     timeVar = \"time\", param = \"td-both\", extraForm = jm1.dform3, \n#&gt;     seed = 55555, n.iter = 35000)\n#&gt; \n#&gt; Data Descriptives:\n#&gt; Longitudinal Process     Event Process\n#&gt; Number of Observations: 3326 Number of Events: 600 (100%)\n#&gt; Number of subjects: 600\n#&gt; \n#&gt; Joint Model Summary:\n#&gt; Longitudinal Process: Linear mixed-effects model\n#&gt; Event Process: Relative risk model with penalized-spline-approximated \n#&gt;      baseline risk function\n#&gt; Parameterization: Time-dependent value + time-dependent extra term \n#&gt; \n#&gt;  LPML          DIC           pD\n#&gt;  -Inf 3.667135e+38 1.833568e+38\n#&gt; \n#&gt; Variance Components:\n#&gt;              StdDev    Corr        \n#&gt; (Intercept)  3.0513  (Intr)    time\n#&gt; time         1.7750 -0.5610        \n#&gt; I(time^2)    9.6936  0.0203  0.1280\n#&gt; Residual     1.4196                \n#&gt; \n#&gt; Coefficients:\n#&gt; Longitudinal Process\n#&gt;               Value Std.Err Std.Dev    2.5%  97.5%      P\n#&gt; (Intercept)  6.6989  0.0577  0.2037  6.2092 7.0213 &lt;0.001\n#&gt; time        -0.0152  0.0171  0.0980 -0.1958 0.1941 0.8383\n#&gt; I(time^2)   -0.0763  0.0086  0.3896 -0.8358 0.6999 0.8431\n#&gt; \n#&gt; Event Process\n#&gt;                               Value Std.Err Std.Dev    2.5%   97.5%      P\n#&gt; marriedMarried/Partnered     0.1622  0.0223  0.2418 -0.3557  0.6060 0.4536\n#&gt; bc_pillsEver use BC pills   -0.0882  0.0231  0.2471 -0.6002  0.4376 0.6683\n#&gt; bmi                         -0.0064  0.0027  0.0204 -0.0527  0.0288 0.7800\n#&gt; factor(site)C                0.1884  0.0339  0.4042 -0.7562  0.9011 0.5187\n#&gt; factor(site)M                0.3531  0.0372  0.4180 -0.5114  1.1810 0.3273\n#&gt; factor(site)NJ               0.0610  0.0925  0.9741 -2.1261  1.7333 0.8169\n#&gt; factor(site)P                0.4613  0.0473  0.4438 -0.5033  1.3523 0.2496\n#&gt; factor(site)UCD              0.2257  0.0377  0.4433 -0.6991  1.0430 0.5566\n#&gt; factor(site)UCLA             0.5056  0.0406  0.4893 -0.4411  1.5114 0.2623\n#&gt; factor(ethnic)BLACK         -0.2085  0.0205  0.2663 -0.7656  0.3051 0.3895\n#&gt; factor(ethnic)CHINE          0.1058  0.0396  0.4686 -0.7910  1.0492 0.8198\n#&gt; factor(ethnic)HISPA         -1.3701  0.1275  1.2556 -4.0169  1.1049 0.2496\n#&gt; factor(ethnic)JAPAN         -0.2247  0.0320  0.4602 -1.1602  0.6744 0.5945\n#&gt; factor(smoke)Past Only       0.1279  0.0189  0.2420 -0.4083  0.5625 0.4934\n#&gt; factor(smoke)Current Smoker  0.4670  0.0282  0.3394 -0.3074  1.0426 0.1787\n#&gt; Assoct                      -0.1613  0.0030  0.0724 -0.3225 -0.0578 &lt;0.001\n#&gt; AssoctE                     10.9666  0.4279  4.3556  4.1155 22.8660 0.0019\n#&gt; tauBs                        0.2734  0.0353  0.1407  0.0837  0.6226     NA\n#&gt; \n#&gt; MCMC summary:\n#&gt; iterations: 35000 \n#&gt; adapt: 3000 \n#&gt; burn-in: 3000 \n#&gt; thinning: 17 \n#&gt; time: 3 min"
  },
  {
    "objectID": "04_jmbayes.html#predictions-fails",
    "href": "04_jmbayes.html#predictions-fails",
    "title": "\n4  JMBayes\n",
    "section": "\n4.5 Predictions Fails",
    "text": "4.5 Predictions Fails\nBecause there is no individual who is not in the event group, we cannot predict the survival outcomes.\nThere is also possiblity that the site is\n\nCodeids &lt;- unique(swan_amh0$id)\n## length(ids)\n## Prediction for the survival outcomes\nND &lt;- swan_amh0[swan_amh0$id == ids[12], ] ## 4, 5, 7 (not so good)\n# pbc2[pbc2$id == 2, ]\n\nsfit &lt;- survfitJM(jmbayes.fit11, newdata = ND)\n\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]): contrasts can be applied only to factors with 2 or more levels\n\nCodesapply(lapply(swan_amh0, unique), length)\n\n#&gt;         id        age       age0    alcohol        amh   bc_pills        bmi \n#&gt;        600         24         11          4       2638          2        599 \n#&gt;    bmi_cat   children        edu   employed     ethnic      etime      event \n#&gt;          3          9          3          2          5        547          1 \n#&gt;    fmp_age     health    married     parity   phys_act       site      smoke \n#&gt;        547          4          2          5        149          7          3 \n#&gt; start_time       time      train      visit       lamh \n#&gt;         11         24          1         12       2638\n\nCodesurvPreds &lt;- vector(\"list\", nrow(ND))\nfor (i in 1:nrow(ND)) {\n    survPreds[[i]] &lt;- try(survfitJM(jmbayes.fit11, newdata = ND[1:i, ]))\n}\n\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : \n#&gt;   contrasts can be applied only to factors with 2 or more levels\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : \n#&gt;   contrasts can be applied only to factors with 2 or more levels\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : \n#&gt;   contrasts can be applied only to factors with 2 or more levels\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : \n#&gt;   contrasts can be applied only to factors with 2 or more levels\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : \n#&gt;   contrasts can be applied only to factors with 2 or more levels\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : \n#&gt;   contrasts can be applied only to factors with 2 or more levels"
  },
  {
    "objectID": "04_jmbayes.html#auc-and-roc",
    "href": "04_jmbayes.html#auc-and-roc",
    "title": "\n4  JMBayes\n",
    "section": "\n4.6 AUC and ROC",
    "text": "4.6 AUC and ROC\nThe AUC and ROC does not improve with the complexity of the model. So far the simplest linear mixed model has the best AUC and ROC lme.fit1. The joint model for stratified survival model surv.fit2 do not provide reasonable standard errors and confidence intervals.\nThe prediction of the survival outcomes from year 5 to year 8.\n\nCodeJMbayes::aucJM(jmbayes.fit11, \n      swan_amh0, \n      Tstart = 5,\n      Thoriz = 8)\n\n#&gt; \n#&gt;  Time-dependent AUC for the Joint Model jmbayes.fit11\n#&gt; \n#&gt; Estimated AUC: 0.8506\n#&gt; At time: 8\n#&gt; Using information up to time: 5 (407 subjects still at risk)\n\nCoderoc11 &lt;- rocJM(jmbayes.fit11, \n           swan_amh0, \n           Tstart = 5,\n           Thoriz = 8)\nJMbayes::aucJM(jmbayes.fit31, \n      swan_amh0, \n      Tstart = 5,\n      Thoriz = 8)\n\n#&gt; \n#&gt;  Time-dependent AUC for the Joint Model jmbayes.fit31\n#&gt; \n#&gt; Estimated AUC: 0.705\n#&gt; At time: 8\n#&gt; Using information up to time: 5 (407 subjects still at risk)\n\nCoderoc31 &lt;- rocJM(jmbayes.fit31, \n           swan_amh0, \n           Tstart = 5,\n           Thoriz = 8) \naucJM(jmbayes.fit31.d,\n      swan_amh0,\n      Tstart = 5,\n      Thoriz = 8)\n\n#&gt; \n#&gt;  Time-dependent AUC for the Joint Model jmbayes.fit31.d\n#&gt; \n#&gt; Estimated AUC: 0.6847\n#&gt; At time: 8\n#&gt; Using information up to time: 5 (407 subjects still at risk)\n\nCoderoc31.d &lt;- rocJM(jmbayes.fit31.d, \n           swan_amh0, \n           Tstart = 5,\n           Thoriz = 8)\n\n\n\nCodeplot(roc11)\nplot(roc31)\nplot(roc31.d)\n\n\n\nROC curve for linear-term model\n\n\n\n\n\nROC curve for quardratic-term model\n\n\n\n\n\nROC curve for quardratic-term and slope model\n\n\nROC curves"
  },
  {
    "objectID": "04_jmbayes.html#brier-score",
    "href": "04_jmbayes.html#brier-score",
    "title": "\n4  JMBayes\n",
    "section": "\n4.7 Brier Score",
    "text": "4.7 Brier Score\nThere is no function to calculate the Brier Score in JMbayes, has to migrate into JMbayes2 package. However there are several functions in both packages interfering with each other, the JMbayes2::tvBrier() will be tested in next chapter R/05_jmbayes2.qmd files.\n\nCodeids &lt;- unique(swan_amh0$id)\n## length(ids)\n## Prediction for the survival outcomes\nND1 &lt;- swan_amh0[swan_amh0$id == ids[5], ] ## 4, 5, 7 (not so good)\nbrier.fit11 &lt;- JMbayes2::tvBrier(jmbayes.fit11, \n                               newdata = ND1, \n                               Tstart = 3, \n                               Dt = 6)\n\n#&gt; Error in JMbayes2::tvBrier(jmbayes.fit11, newdata = ND1, Tstart = 3, Dt = 6): Use only with 'jm' objects.\n\nCodeJMbayes2::tvAUC(jmbayes.fit11, \n      swan_amh0, \n      Tstart = 5,\n      Thoriz = 8)\n\n#&gt; Error in UseMethod(\"tvAUC\"): no applicable method for 'tvAUC' applied to an object of class \"JMbayes\""
  },
  {
    "objectID": "05_jmbayes2.html#no-sites-in-the-survival-model",
    "href": "05_jmbayes2.html#no-sites-in-the-survival-model",
    "title": "\n5  JMbayes2\n",
    "section": "\n5.1 No sites in the survival model",
    "text": "5.1 No sites in the survival model\nHere we are working with survival model without site. I also include the site into the nested design random effect in the longitudinal model lme.fit4.\n\nCodeload(\"data/swan_amh0.rda\")\nload(\"data/swan_amh1.rda\")\n\nswan_amh0 &lt;- swan_amh0 %&gt;% \n  mutate(site = case_when(site == \"11\" ~ \"M\",\n                          site == \"12\" ~ \"B\",\n                          site == \"13\" ~ \"C\",\n                          site == \"14\" ~ \"UCD\",\n                          site == \"15\" ~ \"UCLA\",\n                          site == \"16\" ~ \"NJ\",\n                          site == \"17\" ~ \"P\"))\n\n\n\n5.1.1 lme models and surv models\n\nCodecontrol = lmeControl(opt = \"optim\")\nlme.fit1 &lt;- lme(lamh ~ time,\n                data = swan_amh0,\n                control = control,\n                random = ~ time| id)\n\nlme.fit2 &lt;- lme(lamh ~ time + I(time^2),\n                data = swan_amh0,\n                control = control,\n                random = ~ time| id)\n\nlme.fit3 &lt;- lme(lamh ~ time + I(time^2),\n                data = swan_amh0,\n                control = control,\n                random = ~ time + I(time^2) | id)\n\nlme.fit4 &lt;- lme(lamh ~ time,\n                data = swan_amh0,\n                control = control,\n                random = ~ time| site / id)\n\nsurv.fit1 &lt;- coxph(Surv(etime, event) ~ married + bc_pills + \n                        factor(site) + \n                        bmi + factor(ethnic) + factor(smoke),\n                    data = swan_amh1,\n                    x = TRUE,\n                    model = TRUE)\n\n\nsurv.fit1.nosite &lt;- coxph(Surv(etime, event) ~ married + bc_pills + \n                        # factor(site) + \n                        bmi + factor(ethnic) + factor(smoke),\n                    data = swan_amh1,\n                    x = TRUE,\n                    model = TRUE)\n\nsurv.fit2.nosite &lt;- coxph(Surv(etime, event) ~ married + bc_pills +\n                            # strata(site) + \n                            bmi + strata(ethnic) + strata(smoke),\n                   data = swan_amh1,\n                   x = TRUE,\n                   model = TRUE)\n\n\nHere is the predictive results of joint model from JMbayes2 package. We only remove the site from the survival model.\n\nCodejmcontrol &lt;- list(n_iter = 5000, \n                  n_burnin = 1000, \n                  n_chains = 3,\n                  seed = 55555,\n                  cores = 3)\n\njmbayes2.fit11 &lt;- JMbayes2::jm(Surv_object = surv.fit1,\n                               Mixed_objects = lme.fit1, \n                               time_var = \"time\",\n                               control = jmcontrol) \n\njmbayes2.fit11.nosite &lt;- JMbayes2::jm(Surv_object = surv.fit1.nosite,\n                                      Mixed_objects = lme.fit1, \n                                      time_var = \"time\",\n                                      control = jmcontrol) \n# functional_forms = NULL,\n\n\njmbayes2.fit31.nosite &lt;- JMbayes2::jm(Surv_object = surv.fit1.nosite,\n                                      Mixed_objects = lme.fit3, \n                                      time_var = \"time\",\n                                      control = jmcontrol) \n\n\n\n5.1.2 Joint models summarization\nHere is the summary for the joint models\n\\(lme.fit1 \\sim (fixed = lamh \\sim time, \\ random = \\sim time| id)\\)\n\\(surv.fit1.nosite \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(ethnic) + factor(smoke))\\)\n\nCodesummary(jmbayes2.fit11.nosite)\n\n#&gt; \n#&gt; Call:\n#&gt; JMbayes2::jm(Surv_object = surv.fit1.nosite, Mixed_objects = lme.fit1, \n#&gt;     time_var = \"time\", control = jmcontrol)\n#&gt; \n#&gt; Data Descriptives:\n#&gt; Number of Groups: 600        Number of events: 600 (100%)\n#&gt; Number of Observations:\n#&gt;   lamh: 3326\n#&gt; \n#&gt;                  DIC     WAIC      LPML\n#&gt; marginal    14864.91 14947.39 -7493.383\n#&gt; conditional 15529.92 15309.70 -8097.687\n#&gt; \n#&gt; Random-effects covariance matrix:\n#&gt;                      \n#&gt;        StdDev   Corr \n#&gt; (Intr) 1.6695 (Intr) \n#&gt; time   0.0981 -0.2189\n#&gt; \n#&gt; Survival Outcome:\n#&gt;                                Mean  StDev    2.5%   97.5%      P   Rhat\n#&gt; marriedMarried/Partnered     0.1370 0.1487 -0.1499  0.4318 0.3620 1.0082\n#&gt; bc_pillsEver use BC pills   -0.0123 0.1284 -0.2609  0.2445 0.9371 1.0062\n#&gt; bmi                         -0.0470 0.0088 -0.0642 -0.0294 0.0000 1.0443\n#&gt; factor(ethnic)BLACK         -0.3768 0.1366 -0.6477 -0.1193 0.0020 1.0082\n#&gt; factor(ethnic)CHINE         -0.3621 0.1904 -0.7400  0.0139 0.0613 1.0104\n#&gt; factor(ethnic)HISPA         -0.2688 0.3638 -0.9652  0.4357 0.4527 1.0980\n#&gt; factor(ethnic)JAPAN          0.0949 0.1592 -0.2151  0.4157 0.5393 1.0473\n#&gt; factor(smoke)Past Only      -0.0927 0.1301 -0.3378  0.1780 0.4838 1.0019\n#&gt; factor(smoke)Current Smoker  0.2262 0.1772 -0.1205  0.5635 0.2100 1.0034\n#&gt; value(lamh)                 -0.9795 0.0839 -1.1938 -0.8381 0.0000 1.9560\n#&gt; \n#&gt; Longitudinal Outcome: lamh (family = gaussian, link = identity)\n#&gt;                Mean  StDev    2.5%   97.5% P   Rhat\n#&gt; (Intercept)  7.8964 0.1069  7.6786  8.1089 0 1.1336\n#&gt; time        -0.5932 0.0122 -0.6167 -0.5662 0 1.1840\n#&gt; sigma        1.3087 0.0196  1.2711  1.3464 0 1.0983\n#&gt; \n#&gt; MCMC summary:\n#&gt; chains: 3 \n#&gt; iterations per chain: 3500 \n#&gt; burn-in per chain: 500 \n#&gt; thinning: 1 \n#&gt; time: 13 sec\n\n\n\\(lme.fit3 \\sim (fixed = lamh \\sim time + I(time^2), \\ random = \\sim time + I(time^2) | id)\\)\n\\(surv.fit1.nosite \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(ethnic) + factor(smoke))\\)\n\nCodesummary(jmbayes2.fit31.nosite)\n\n#&gt; \n#&gt; Call:\n#&gt; JMbayes2::jm(Surv_object = surv.fit1.nosite, Mixed_objects = lme.fit3, \n#&gt;     time_var = \"time\", control = jmcontrol)\n#&gt; \n#&gt; Data Descriptives:\n#&gt; Number of Groups: 600        Number of events: 600 (100%)\n#&gt; Number of Observations:\n#&gt;   lamh: 3326\n#&gt; \n#&gt;                  DIC     WAIC      LPML\n#&gt; marginal    14586.06 14791.78 -7404.593\n#&gt; conditional 11610.39 11463.52 -6301.342\n#&gt; \n#&gt; Random-effects covariance matrix:\n#&gt;                              \n#&gt;        StdDev   Corr         \n#&gt; (Intr) 1.1012 (Intr)  00time \n#&gt; time   0.1835 0.5630         \n#&gt; I(t^2) 0.0140 -0.4625 -0.6009\n#&gt; \n#&gt; Survival Outcome:\n#&gt;                                Mean  StDev    2.5%   97.5%      P   Rhat\n#&gt; marriedMarried/Partnered     0.1327 0.1603 -0.1777  0.4485 0.4193 1.0004\n#&gt; bc_pillsEver use BC pills    0.0183 0.1352 -0.2344  0.2874 0.8967 1.0027\n#&gt; bmi                         -0.0493 0.0096 -0.0685 -0.0305 0.0000 1.0178\n#&gt; factor(ethnic)BLACK         -0.3812 0.1496 -0.6774 -0.0909 0.0082 1.0081\n#&gt; factor(ethnic)CHINE         -0.3529 0.2088 -0.7704  0.0489 0.0849 1.0285\n#&gt; factor(ethnic)HISPA         -0.1895 0.4395 -1.0725  0.6252 0.6971 1.0028\n#&gt; factor(ethnic)JAPAN          0.1717 0.1749 -0.1743  0.5089 0.3247 1.0011\n#&gt; factor(smoke)Past Only      -0.1407 0.1448 -0.4373  0.1322 0.3280 1.0080\n#&gt; factor(smoke)Current Smoker  0.2021 0.1977 -0.1781  0.5721 0.3244 1.0080\n#&gt; value(lamh)                 -1.0303 0.0701 -1.1732 -0.9045 0.0000 1.0633\n#&gt; \n#&gt; Longitudinal Outcome: lamh (family = gaussian, link = identity)\n#&gt;                Mean  StDev    2.5%   97.5%     P   Rhat\n#&gt; (Intercept)  6.4251 0.1224  6.1925  6.6934 0e+00 1.3366\n#&gt; time        -0.0846 0.0359 -0.1839 -0.0295 7e-04 1.5178\n#&gt; I(time^2)   -0.0392 0.0030 -0.0437 -0.0315 0e+00 1.2946\n#&gt; sigma        1.2631 0.0182  1.2278  1.2998 0e+00 1.0050\n#&gt; \n#&gt; MCMC summary:\n#&gt; chains: 3 \n#&gt; iterations per chain: 3500 \n#&gt; burn-in per chain: 500 \n#&gt; thinning: 1 \n#&gt; time: 15 sec\n\n\nThere is no anova() for JMbayes2 package, However, there is the compare_jm function in the package.\nneed to talk with EJC whether we need to include the slope terms\n\nCode## there is no anova function in JMbayes2\nanova(jmbayes2.fit11.nosite, jmbayes2.fit31.nosite)\n\n#&gt; Error in UseMethod(\"anova\"): no applicable method for 'anova' applied to an object of class \"jm\"\n\nCodecompare_jm(jmbayes2.fit11.nosite,\n           jmbayes2.fit31.nosite)\n\n#&gt; \n#&gt;                             DIC     WAIC      LPML\n#&gt;  jmbayes2.fit31.nosite 14586.06 14791.78 -7404.593\n#&gt;  jmbayes2.fit11.nosite 14864.91 14947.39 -7493.383\n#&gt; \n#&gt; The criteria are calculated based on the marginal log-likelihood.\n\n\nTraceplots with base R, convergence is not so well.\n\nCodetraceplot(jmbayes2.fit11.nosite)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nTraceplot for the joint model with ggplot\n\nCodeggtraceplot(jmbayes2.fit31.nosite,\n            ## \"betas\", \"sigmas\", \n            ## \"D\", \"bs_gammas\",\n            ## \"tau_bs_gammas\", \"gammas\", \"alphas\"\n            parm = \"betas\",\n            size = 0.3, \n            alpha = 0.8,\n            ## c('standard', 'catalog', 'metro',\n            ##   'pastel', 'beach', 'moonlight', \n            ##   'goo', 'sunset', 'custom')\n            theme = \"moonlight\",\n            grid = FALSE, \n            gridcols = 2)\nggtraceplot(jmbayes2.fit31.nosite,\n            ## \"betas\", \"sigmas\", \n            ## \"D\", \"bs_gammas\",\n            ## \"tau_bs_gammas\", \"gammas\", \"alphas\"\n            parm = \"gammas\",\n            size = 0.3, \n            alpha = 0.8,\n            ## c('standard', 'catalog', 'metro',\n            ##   'pastel', 'beach', 'moonlight', \n            ##   'goo', 'sunset', 'custom')\n            theme = \"moonlight\",\n            grid = FALSE, \n            gridcols = 2)"
  },
  {
    "objectID": "05_jmbayes2.html#nested-linear-mixed-model",
    "href": "05_jmbayes2.html#nested-linear-mixed-model",
    "title": "\n5  JMbayes2\n",
    "section": "\n5.2 Nested linear mixed model",
    "text": "5.2 Nested linear mixed model\nThe site is not in the longitudinal dataset swan_amh0, but it is in the survival dataset swan_amh1?\nThere is some problem for the nested linear mixed model:\n“Indeed, nested random-effects structures are not yet supported in JMbayes2.” by Dimitris Rizopoulos.\n\\(lme.fit4 \\sim lme(lamh \\sim time, random = \\sim time| site / id)\\)\n\\(surv.fit1 \\sim coxph(Surv(etime, event) \\sim married + bc_pills + bmi + factor(ethnic) + factor(smoke)\\)\n\nCodesummary(lme.fit4)\n\n#&gt; Linear mixed-effects model fit by REML\n#&gt;   Data: swan_amh0 \n#&gt;        AIC      BIC    logLik\n#&gt;   12570.79 12625.77 -6276.396\n#&gt; \n#&gt; Random effects:\n#&gt;  Formula: ~time | site\n#&gt;  Structure: General positive-definite, Log-Cholesky parametrization\n#&gt;             StdDev    Corr  \n#&gt; (Intercept) 0.4503209 (Intr)\n#&gt; time        0.0550350 -0.759\n#&gt; \n#&gt;  Formula: ~time | id %in% site\n#&gt;  Structure: General positive-definite, Log-Cholesky parametrization\n#&gt;             StdDev     Corr  \n#&gt; (Intercept) 1.61987662 (Intr)\n#&gt; time        0.08386827 -0.295\n#&gt; Residual    1.30160865       \n#&gt; \n#&gt; Fixed effects:  lamh ~ time \n#&gt;                 Value  Std.Error   DF   t-value p-value\n#&gt; (Intercept)  7.503743 0.20297720 2725  36.96840       0\n#&gt; time        -0.528080 0.02444278 2725 -21.60476       0\n#&gt;  Correlation: \n#&gt;      (Intr)\n#&gt; time -0.757\n#&gt; \n#&gt; Standardized Within-Group Residuals:\n#&gt;        Min         Q1        Med         Q3        Max \n#&gt; -5.2245239 -0.4833631  0.1091414  0.6053437  2.9140076 \n#&gt; \n#&gt; Number of Observations: 3326\n#&gt; Number of Groups: \n#&gt;         site id %in% site \n#&gt;            7          600\n\nCodejmbayes2.fit41.nosite &lt;- JMbayes2::jm(Surv_object = surv.fit1.nosite,\n                                      Mixed_objects = lme.fit4, \n                                      time_var = \"time\") \n\n#&gt; Error in mat[id, ] &lt;- b: number of items to replace is not a multiple of replacement length\n\n\nAlso trying different ways of adding nested or crossed random effects. None of these works with the JMbayes2 package. So including the random site:ethnicity effects does not work through the linear mixed models.\n\nCodelme.fit5 &lt;- lme(lamh ~ time,\n                data = swan_amh0,\n                control = control,\n                ## does not work for the jm model\n                # random = list(site = pdSymm(~ time),\n                #               id = pdDiag(~ time)),\n                # random = list(site = ~ time,\n                #                id = ~ time),\n                # random = list(~1 | site,\n                #               ~time | id),\n                random = ~ time| site / id,\n                ## does not work for the jm model\n                )\n\nsummary(lme.fit5)\n\n#&gt; Linear mixed-effects model fit by REML\n#&gt;   Data: swan_amh0 \n#&gt;        AIC      BIC    logLik\n#&gt;   12570.79 12625.77 -6276.396\n#&gt; \n#&gt; Random effects:\n#&gt;  Formula: ~time | site\n#&gt;  Structure: General positive-definite, Log-Cholesky parametrization\n#&gt;             StdDev    Corr  \n#&gt; (Intercept) 0.4503209 (Intr)\n#&gt; time        0.0550350 -0.759\n#&gt; \n#&gt;  Formula: ~time | id %in% site\n#&gt;  Structure: General positive-definite, Log-Cholesky parametrization\n#&gt;             StdDev     Corr  \n#&gt; (Intercept) 1.61987662 (Intr)\n#&gt; time        0.08386827 -0.295\n#&gt; Residual    1.30160865       \n#&gt; \n#&gt; Fixed effects:  lamh ~ time \n#&gt;                 Value  Std.Error   DF   t-value p-value\n#&gt; (Intercept)  7.503743 0.20297720 2725  36.96840       0\n#&gt; time        -0.528080 0.02444278 2725 -21.60476       0\n#&gt;  Correlation: \n#&gt;      (Intr)\n#&gt; time -0.757\n#&gt; \n#&gt; Standardized Within-Group Residuals:\n#&gt;        Min         Q1        Med         Q3        Max \n#&gt; -5.2245239 -0.4833631  0.1091414  0.6053437  2.9140076 \n#&gt; \n#&gt; Number of Observations: 3326\n#&gt; Number of Groups: \n#&gt;         site id %in% site \n#&gt;            7          600\n\nCodejmbayes2.fit51.nosite &lt;- JMbayes2::jm(Surv_object = surv.fit1.nosite,\n                                      Mixed_objects = lme.fit5, \n                                      time_var = \"time\") \n\n#&gt; Error in mat[id, ] &lt;- b: number of items to replace is not a multiple of replacement length"
  },
  {
    "objectID": "05_jmbayes2.html#prediction-accuracy",
    "href": "05_jmbayes2.html#prediction-accuracy",
    "title": "\n5  JMbayes2\n",
    "section": "\n5.3 Prediction Accuracy",
    "text": "5.3 Prediction Accuracy\n\nCodet0 &lt;- 3\nids &lt;- unique(swan_amh0$id)\n## length(ids)\n## Prediction for the survival outcomes\nND1 &lt;- swan_amh0 %&gt;%\n  filter(id %in% c(ids[5], id[6]),\n         time &lt; t0)\n## 4, 5, 7 (not so good)\n\nND1$event &lt;- 0\nND1$etime &lt;- t0\n\n\n\n5.3.1 Dynamic prediction\nNotes: we select the subject for whom we want to calculate predictions, we use measurements up to follow-up year 3; we also set that the patients were alive up to this time point.\n\nCodepredLong &lt;- predict(jmbayes2.fit11.nosite, \n                    newdata = ND1,\n                    times = seq(3, 8, by = 0.5),\n                    return_newdata = TRUE)\n\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]): contrasts can be applied only to factors with 2 or more levels\n\nCodepredLong_all &lt;- predict(jmbayes2.fit11.nosite, \n                        newdata = swan_amh1,\n                        return_newdata = TRUE)\n\npredSurv_all &lt;- predict(jmbayes2.fit11.nosite, \n                        newdata = ND1,\n                        times = 1:2,\n                        process = \"event\",\n                        return_newdata = TRUE)\n\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]): contrasts can be applied only to factors with 2 or more levels\n\n\n\n5.3.2 AUC\nIt seems like the AUC, ROC, and Brier Score only works for the prediction for the whole dataset, not for the single individual. I do not know why this keep happening.\n\nCodeJMbayes2::tvAUC(jmbayes2.fit11.nosite, \n                swan_amh0, \n                Tstart = 5,\n                Thoriz = 8)\n\n#&gt; \n#&gt;  Time-dependent AUC for the Joint Model jmbayes2.fit11.nosite\n#&gt; \n#&gt; Estimated AUC: 0.8293\n#&gt; At time: 8\n#&gt; Using information up to time: 5 (407 subjects still at risk)\n\nCodeJMbayes2::tvAUC(jmbayes2.fit11.nosite, \n                ND1, \n                Tstart = 5,\n                Thoriz = 8)\n\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]): contrasts can be applied only to factors with 2 or more levels\n\n\n\n5.3.3 Calibration Plot\n\nCodeJMbayes2::calibration_plot(jmbayes2.fit11.nosite, \n                           newdata = ND1, \n                           Tstart = 5,\n                           Thoriz = 8)\n\n#&gt; Error in JMbayes2::calibration_plot(jmbayes2.fit11.nosite, newdata = ND1, : there are no data on subjects who had an observed event time after Tstart and longitudinal measurements before Tstart.\n\nCodeJMbayes2::calibration_plot(jmbayes2.fit11.nosite, \n                           swan_amh0, \n                           Tstart = 5,\n                           Thoriz = 8)\n\n\n\nCode# View(swan_amh0) the left truncation\n\n\n\n5.3.4 ROC\n\nCodeJMbayes2::tvROC(jmbayes2.fit11.nosite, \n                ND1, \n                Tstart = 5,\n                Thoriz = 8)\n\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]): contrasts can be applied only to factors with 2 or more levels\n\nCoderoc.fit11.nosite &lt;- JMbayes2::tvROC(jmbayes2.fit11.nosite, \n                                    swan_amh0, \n                                    Tstart = 5,\n                                    Thoriz = 8)\n\nplot(roc.fit11.nosite)\n\n\n\n\n\n5.3.5 Brier Score\nHowever there are several functions in both packages interfering with each other, the JMbayes2::tvBrier().\nUsing the available longitudinal information up to a starting time point, these functions compute estimates of the ROC curve and the AUC, the Brier score and expected predictive cross-entropy at a horizon time point based on joint models.\nI can calculate the Brier score for a group of people or the whole dataset, but not for single individual.\n\nCode## I cannot predict for single person \n## but I can predict for the whole dataset\nJMbayes2::tvBrier(jmbayes2.fit11.nosite, \n                  newdata = ND1, \n                  Tstart = 5, \n                  Dt = 8)\n\n#&gt; Warning in br(Thoriz): there are fewer than 5 subjects with an event in the interval [5.000001, 13).\n\n\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]): contrasts can be applied only to factors with 2 or more levels\n\nCodeJMbayes2::tvBrier(jmbayes2.fit11, \n                  newdata = ND1, \n                  Tstart = 5, \n                  Dt = 8)\n\n#&gt; Warning in br(Thoriz): there are fewer than 5 subjects with an event in the interval [5.000001, 13).\n\n\n#&gt; Error in `contrasts&lt;-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]): contrasts can be applied only to factors with 2 or more levels\n\nCodeJMbayes2::tvBrier(jmbayes2.fit11, \n                  swan_amh0, \n                  integrated = TRUE,\n                  # integrated logical; \n                  # if TRUE the integrated Brier score is calculated\n                  Tstart = 5,\n                  Thoriz = 8)\n\n#&gt; \n#&gt; Prediction Error for the Joint Model 'jmbayes2.fit11'\n#&gt; \n#&gt; Estimated Integrated Brier score: 0.0359\n#&gt; In the time interval: [5, 8)\n#&gt; For the 407 subjects at risk at time 5\n#&gt; Number of subjects with an event in [5, 8): 63\n#&gt; Number of subjects with a censored time in [5, 8): 0\n#&gt; Accounting for censoring using model-based weights\n\nCodeJMbayes2::tvBrier(jmbayes2.fit11, \n                  swan_amh0, \n                  integrated = FALSE,\n                  # integrated logical; \n                  # if TRUE the integrated Brier score is calculated\n                  Tstart = 5,\n                  Thoriz = 8)\n\n#&gt; \n#&gt; Prediction Error for the Joint Model 'jmbayes2.fit11'\n#&gt; \n#&gt; Estimated Brier score: 0.108\n#&gt; At time: 8\n#&gt; For the 407 subjects at risk at time 5\n#&gt; Number of subjects with an event in [5, 8): 63\n#&gt; Number of subjects with a censored time in [5, 8): 0\n#&gt; Accounting for censoring using model-based weights\n\nCodeJMbayes2::tvBrier(jmbayes2.fit11.nosite, \n                  swan_amh0, \n                  integrated = TRUE,\n                  Tstart = 5,\n                  Thoriz = 8)\n\n#&gt; \n#&gt; Prediction Error for the Joint Model 'jmbayes2.fit11.nosite'\n#&gt; \n#&gt; Estimated Integrated Brier score: 0.0356\n#&gt; In the time interval: [5, 8)\n#&gt; For the 407 subjects at risk at time 5\n#&gt; Number of subjects with an event in [5, 8): 63\n#&gt; Number of subjects with a censored time in [5, 8): 0\n#&gt; Accounting for censoring using model-based weights\n\nCodeJMbayes2::tvBrier(jmbayes2.fit11.nosite, \n                  swan_amh0, \n                  integrated = FALSE,\n                  Tstart = 5,\n                  Thoriz = 8)\n\n#&gt; \n#&gt; Prediction Error for the Joint Model 'jmbayes2.fit11.nosite'\n#&gt; \n#&gt; Estimated Brier score: 0.106\n#&gt; At time: 8\n#&gt; For the 407 subjects at risk at time 5\n#&gt; Number of subjects with an event in [5, 8): 63\n#&gt; Number of subjects with a censored time in [5, 8): 0\n#&gt; Accounting for censoring using model-based weights"
  },
  {
    "objectID": "06_jm_model_selection.html#merge-site-and-ethnicity-variables",
    "href": "06_jm_model_selection.html#merge-site-and-ethnicity-variables",
    "title": "\n6  JM Model Selection\n",
    "section": "\n6.1 Merge site and ethnicity variables",
    "text": "6.1 Merge site and ethnicity variables\nChanging the Site:Ethnicity into a 14-level factor variable.\n\nCodeswan_amh00 &lt;- swan_amh0 %&gt;%\n  mutate(site = case_when(site == 11 ~ \"M\",\n                          site == 12 ~ \"B\",\n                          site == 13 ~ \"C\",\n                          site == 14 ~ \"UCD\",\n                          site == 15 ~ \"UCLA\",\n                          site == 16 ~ \"NJ\",\n                          site == 17 ~ \"P\")) %&gt;%\n  tidyr::unite(\"site_ethnic\", \"site\",\n               \"ethnic\", sep = \"_\",\n               remove = TRUE) %&gt;%\n  mutate(site_ethinic = factor(site_ethnic))\n\n\nswan_amh11 &lt;- swan_amh1 %&gt;%\n  # mutate(site = case_when(site == 11 ~ \"M\",\n  #                         site == 12 ~ \"B\",\n  #                         site == 13 ~ \"C\",\n  #                         site == 14 ~ \"UCD\",\n  #                         site == 15 ~ \"UCLA\",\n  #                         site == 16 ~ \"NJ\",\n  #                         site == 17 ~ \"P\")) %&gt;%\n  tidyr::unite(\"site_ethnic\", \"site\", \n               \"ethnic\", sep = \"_\", \n               remove = TRUE) %&gt;%\n  mutate(site_ethinic = factor(site_ethnic))\n\ntable(swan_amh11$site_ethnic)\n\n#&gt; \n#&gt;    B_BLACK    B_CAUCA    C_BLACK    C_CAUCA    M_BLACK    M_CAUCA   NJ_CAUCA \n#&gt;         39         57         41         35         64         39          9 \n#&gt;   NJ_HISPA    P_BLACK    P_CAUCA  UCD_CAUCA  UCD_CHINE UCLA_CAUCA UCLA_JAPAN \n#&gt;         18         26         48         40         62         37         85"
  },
  {
    "objectID": "06_jm_model_selection.html#model-selection",
    "href": "06_jm_model_selection.html#model-selection",
    "title": "\n6  JM Model Selection\n",
    "section": "\n6.2 Model Selection",
    "text": "6.2 Model Selection\n\nCodecontrol = lmeControl(opt = \"optim\")\nlme.fit1 &lt;- lme(lamh ~ time,\n                data = swan_amh00,\n                control = control,\n                random = ~ time| id)\n\nlme.fit2 &lt;- lme(lamh ~ time + I(time^2),\n                data = swan_amh00,\n                control = control,\n                random = ~ time| id)\n\nlme.fit3 &lt;- lme(lamh ~ time + I(time^2),\n                data = swan_amh00,\n                control = control,\n                random = ~ time + I(time^2) | id)\n\n### Need to keep site + ethnic + smoke + bmi\n## testing for physical activity (taking out phys.act)\nsurv.fit11 &lt;- coxph(Surv(etime, event) ~ married + bc_pills + children + bmi +\n                      factor(site_ethnic) + factor(smoke) +\n                      factor(edu) + factor(alcohol) + \n                      factor(employed) + factor(health),\n                    data = swan_amh11, \n                    x = TRUE, \n                    model = TRUE)\n\n## testing for employed\nsurv.fit12 &lt;- coxph(Surv(etime, event) ~ married + bc_pills + children + bmi +\n                      factor(site_ethnic) + factor(smoke) +\n                      factor(edu) + factor(alcohol) + factor(health),\n                    data = swan_amh11, x = TRUE, model = TRUE)\n\n## testing for children\nsurv.fit13 &lt;- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                      factor(site_ethnic) + factor(smoke) +\n                      factor(edu) + factor(alcohol) + factor(health),\n                    data = swan_amh11, x = TRUE, model = TRUE)\n\n\n## testing for edu (education)\nsurv.fit14 &lt;- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                      factor(site_ethnic) + factor(smoke) +\n                      factor(alcohol) + factor(health),\n                    data = swan_amh11, \n                    x = TRUE,\n                    model = TRUE)\n\n\n## testing for alcohol\nsurv.fit15 &lt;- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                      factor(site_ethnic) + factor(smoke) +\n                      factor(health),\n                    data = swan_amh11, \n                    x = TRUE,\n                    model = TRUE)\n\n\n## testing for health\nsurv.fit16 &lt;- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                      factor(site_ethnic) + factor(smoke),\n                    data = swan_amh11, \n                    x = TRUE,\n                    model = TRUE)\n\n\n## testing for bc_pills\nsurv.fit17 &lt;- coxph(Surv(etime, event) ~ married + bmi +\n                      factor(site_ethnic) + factor(smoke),\n                    data = swan_amh11, \n                    x = TRUE, \n                    model = TRUE)"
  },
  {
    "objectID": "06_jm_model_selection.html#using-jmbayes-to-fit-the-models",
    "href": "06_jm_model_selection.html#using-jmbayes-to-fit-the-models",
    "title": "\n6  JM Model Selection\n",
    "section": "\n6.3 Using JMbayes to fit the models",
    "text": "6.3 Using JMbayes to fit the models\nModel selection suggested \\(surv.fit17 \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(site) + factor(ethnic) + factor(smoke))\\) OR \\(surv.fit15 \\sim coxph(Surv(etime, event) \\sim married + bmi + factor(site) + factor(ethnic) + factor(smoke))\\)\n\nCodejmcontrol &lt;- list(n.iter = 5000,\n                  n.burnin = 1000, \n                  n_chains = 3,\n                  seed = 55555,\n                  cores = 3)\njmbayes.fit111 &lt;- JMbayes::jointModelBayes(lme.fit1,\n                                          surv.fit11,\n                                          timeVar = \"time\",\n                                          control = jmcontrol,\n                                          # time_var = \"time\",\n                                          seed = 55555)\n\n#&gt; Warning in JMbayes::jointModelBayes(lme.fit1, surv.fit11, timeVar = \"time\", :\n#&gt; unknown names in control: n_chains, cores\n\n\n#&gt; Warning in !inherits(test, \"try-error\") && !opt2$convergence &&\n#&gt; eigen(opt2$hessian, : 'length(x) = 46 &gt; 1' in coercion to 'logical(1)'\n\nCodejmbayes.fit112 &lt;- JMbayes::jointModelBayes(lme.fit1,\n                                          surv.fit12,\n                                          timeVar = \"time\",\n                                          control = jmcontrol,\n                                          seed = 55555)\n\n#&gt; Warning in JMbayes::jointModelBayes(lme.fit1, surv.fit12, timeVar = \"time\", :\n#&gt; unknown names in control: n_chains, cores\n\n\n#&gt; Warning in !inherits(test, \"try-error\") && !opt2$convergence &&\n#&gt; eigen(opt2$hessian, : 'length(x) = 45 &gt; 1' in coercion to 'logical(1)'\n\nCodejmbayes.fit113 &lt;- JMbayes::jointModelBayes(lme.fit1,\n                                          surv.fit13,\n                                          timeVar = \"time\",\n                                          control = jmcontrol,\n                                          seed = 55555)\n\n#&gt; Warning in JMbayes::jointModelBayes(lme.fit1, surv.fit13, timeVar = \"time\", :\n#&gt; unknown names in control: n_chains, cores\n\n\n#&gt; Warning in !inherits(test, \"try-error\") && !opt2$convergence &&\n#&gt; eigen(opt2$hessian, : 'length(x) = 44 &gt; 1' in coercion to 'logical(1)'\n\nCodejmbayes.fit114 &lt;- JMbayes::jointModelBayes(lme.fit1,\n                                          surv.fit14,\n                                          timeVar = \"time\",\n                                          control = jmcontrol,\n                                          seed = 55555)\n\n#&gt; Warning in JMbayes::jointModelBayes(lme.fit1, surv.fit14, timeVar = \"time\", :\n#&gt; unknown names in control: n_chains, cores\n\n\n#&gt; Warning in !inherits(test, \"try-error\") && !opt2$convergence &&\n#&gt; eigen(opt2$hessian, : 'length(x) = 42 &gt; 1' in coercion to 'logical(1)'\n\nCodejmbayes.fit115 &lt;- JMbayes::jointModelBayes(lme.fit1,\n                                          surv.fit15,\n                                          timeVar = \"time\",\n                                          control = jmcontrol,\n                                          seed = 55555)\n\n#&gt; Warning in JMbayes::jointModelBayes(lme.fit1, surv.fit15, timeVar = \"time\", :\n#&gt; unknown names in control: n_chains, cores\n\n\n#&gt; Warning in !inherits(test, \"try-error\") && !opt2$convergence &&\n#&gt; eigen(opt2$hessian, : 'length(x) = 39 &gt; 1' in coercion to 'logical(1)'\n\nCodejmbayes.fit116 &lt;- JMbayes::jointModelBayes(lme.fit1,\n                                          surv.fit16,\n                                          timeVar = \"time\",\n                                          control = jmcontrol,\n                                          seed = 55555)\n\n#&gt; Warning in JMbayes::jointModelBayes(lme.fit1, surv.fit16, timeVar = \"time\", :\n#&gt; unknown names in control: n_chains, cores\n\n\n#&gt; Warning in !inherits(test, \"try-error\") && !opt2$convergence &&\n#&gt; eigen(opt2$hessian, : 'length(x) = 36 &gt; 1' in coercion to 'logical(1)'\n\nCodejmbayes.fit117 &lt;- JMbayes::jointModelBayes(lme.fit1,\n                                          surv.fit17,\n                                          timeVar = \"time\",\n                                          control = jmcontrol,\n                                          seed = 55555)\n\n#&gt; Warning in JMbayes::jointModelBayes(lme.fit1, surv.fit17, timeVar = \"time\", :\n#&gt; unknown names in control: n_chains, cores\n\n\n#&gt; Warning in !inherits(test, \"try-error\") && !opt2$convergence &&\n#&gt; eigen(opt2$hessian, : 'length(x) = 35 &gt; 1' in coercion to 'logical(1)'\n\n\n\nCodeanova(jmbayes.fit111, \n      jmbayes.fit112,\n      jmbayes.fit113, \n      jmbayes.fit114,\n      jmbayes.fit115,\n      jmbayes.fit116,\n      jmbayes.fit117)"
  },
  {
    "objectID": "summary.html#section",
    "href": "summary.html#section",
    "title": "8  Working log",
    "section": "8.1 20240401",
    "text": "8.1 20240401\n\nMerge the site and ethnicity into 14 level factor\nAge is not the variable into the model; remove it, the age is already registered, with age all started from 42\nLinear and quadratic terms for rate model \\(m'(t)\\)\nCompare the linear & quadratic terms without the rate model\nWith rate for linear and quadratic get rid of the quadratic term first.\nShould we include interaction terms??? (the team already decided to what included into the model)"
  },
  {
    "objectID": "summary.html#section-1",
    "href": "summary.html#section-1",
    "title": "8  Working log",
    "section": "8.2 20240405",
    "text": "8.2 20240405\n\n[] Test if taking out all CATegorical vars you are able to do a specific dynamic prediction (for a given pat)\nCombine site and ethnicity variables into a single var with 14 levels,\n[] Compare models with and without rate in the survival model\nAUC, ROC, and Brier Score… It is possible to calculate AUC and brier score for the entire dataset"
  },
  {
    "objectID": "07_auc_roc.html#fit-the-joint-model",
    "href": "07_auc_roc.html#fit-the-joint-model",
    "title": "\n7  AUC and ROC\n",
    "section": "\n7.1 Fit the joint model",
    "text": "7.1 Fit the joint model\nHere is the joint model with JMbayes2, the name of the model is set up as package + [fit] + lme_number + surv_number\n\\(lme.fit1 \\sim (fixed = lamh \\sim time, \\ random = \\sim time| id)\\)\n\\(surv.fit16 \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(site) + factor(ethnic) + factor(smoke))\\)\nThe predict.jm() function cannot take the factor variables, so we need to convert them to numeric variables.\nSo here is the dummy variables for the factor variables site_ethnic and smoke. It is weird, just like including the interaction terms without the main effects for the site and ethnicity; talk with EJC to see whether we change the main factor effects back.\n\nCodeswan_amh12 &lt;- swan_amh11 %&gt;%\n  cbind(model.matrix(~ 0 + site_ethnic + smoke, \n                                    data = .)) %&gt;%\n  janitor::clean_names() %&gt;% \n  dplyr::select(order(colnames(.)))\n\nswan_amh02 &lt;- swan_amh00 %&gt;%\n  mutate(smoke = case_when(smoke == 1 ~ \"Past Only\",\n                           smoke == 2 ~ \"Current Smoker\",\n                           smoke == 3 ~ \"Never Smoked\"),\n         smoke = factor(smoke, levels = c(\"Never Smoked\" , \"Past Only\", \"Current Smoker\"))) %&gt;%\n  cbind(model.matrix(~ 0 + site_ethnic + smoke, \n                                    data = .)) %&gt;%\n  janitor::clean_names() %&gt;% \n  dplyr::select(order(colnames(.)))\n\n# names(swan_amh12)\n# names(swan_amh02)\n# \"site_ethnic_b_black\"    \"site_ethnic_b_cauca\"\n# \"site_ethnic_c_black\"    \"site_ethnic_c_cauca\"    \"site_ethnic_m_black\"\n# \"site_ethnic_m_cauca\"    \"site_ethnic_nj_cauca\"   \"site_ethnic_nj_hispa\"\n# \"site_ethnic_p_black\"    \"site_ethnic_p_cauca\"    \"site_ethnic_ucd_cauca\"\n# \"site_ethnic_ucd_chine\"  \"site_ethnic_ucla_cauca\" \"site_ethnic_ucla_japan\"\n# \"smoke_past_only\"        \"smoke_current_smoker\"\n\n\n\nCodecontrol = lmeControl(opt = \"optim\")\nlme.fit1 &lt;- lme(lamh ~ time,\n                data = swan_amh00,\n                control = control,\n                random = ~ time| id)\n\n## testing for health\n## site_ethnic_b_cauca as the reference group \nsurv.fit16 &lt;- coxph(Surv(etime, event) ~ 0 + married + bc_pills + bmi +\n                      site_ethnic_b_black + # site_ethnic_b_cauca + \n                      site_ethnic_c_black + site_ethnic_c_cauca + \n                      site_ethnic_m_black + site_ethnic_m_cauca +\n                      site_ethnic_nj_cauca + site_ethnic_nj_hispa +\n                      site_ethnic_p_black + site_ethnic_p_cauca + \n                      site_ethnic_ucd_cauca + site_ethnic_ucd_chine +\n                      site_ethnic_ucla_cauca + site_ethnic_ucla_japan +\n                      smoke_past_only + smoke_current_smoker,\n                    data = swan_amh12, \n                    x = TRUE,\n                    model = TRUE)\n\njmcontrol &lt;- list(n_iter = 5000, \n                  n_burnin = 1000, \n                  n_chains = 1,\n                  seed = 55555,\n                  cores = 1)\n\njmbayes2.fit116 &lt;- JMbayes2::jm(Surv_object = surv.fit16,\n                               Mixed_objects = lme.fit1, \n                               time_var = \"time\",\n                               control = jmcontrol) \n\n\n\n7.1.1 Summary for the jmbayes.fit116\n\nFor the lme model:\n\nCodesummary(jmbayes2.fit116)$Outcome1 \n\n\n\n  \n\n\nCode#             Mean        StDev       2.5%        97.5%.      P\n# (Intercept)   7.9174517     0.1088784   7.6937029   8.1155217   0\n# time        -0.5961157    0.0129068     -0.6186083    -0.5691261  0\n# sigma       1.3059261   0.0186472   1.2692610   1.3428203     0\n\n\nFor the surv model:\n\nCodesummary(jmbayes2.fit116)$Survival\n\n\n\n  \n\n\n\n\n7.1.2 Traceplots\nLonger chains and more number of chains are better for convergence in real analysis\n\nCodeJMbayes2::traceplot(jmbayes2.fit116)"
  },
  {
    "objectID": "07_auc_roc.html#predictive-accuracy-measures",
    "href": "07_auc_roc.html#predictive-accuracy-measures",
    "title": "\n7  AUC and ROC\n",
    "section": "\n7.2 Predictive accuracy measures",
    "text": "7.2 Predictive accuracy measures\nThe materials are directly from Dimitris Rizopoulos & Grigorios Papageorg (details seen JMwithR notes 6.3)\n\nDiscrimination: sensitivity, specificity, ROC and AUC\nCalibration: comparison between predicted and observed probabilities\nOverall: combination of discrimination and calibration\n\nSidenotes: we do not have right censor (possessively considering the left censor)\nTo estimate the sensitivity, specificity and the AUC, we need to account for censoring. Two main approaches: - model-based weights - Advantage: it allows censoring to depend on the longitudinal history (in any possible manner) - Disadvantage: it requires that the model is well calibrated\n\n\ninverse probability of censoring weighting (IPCW) (using Kaplan-Meier or other non-parametric estimators)\n\nAdvantage: it provides unbiased estimates even when the model is misspecified\nDisadvantage: it requires that the model for the weights is correct\nin settings where joint models are used, challenging because censoring may depend on the longitudinal outcomes in a complex manner\n\n\n\n\n\n\n\n:::{#quarto-navigation-envelope .hidden}\n[SWAN AMH project analysis]{.hidden render-id=\"quarto-int-sidebar-title\"}\n[SWAN AMH project analysis]{.hidden render-id=\"quarto-int-navbar-title\"}\n[&lt;span class='chapter-number'&gt;8&lt;/span&gt;  &lt;span class='chapter-title'&gt;Working log&lt;/span&gt;]{.hidden render-id=\"quarto-int-next\"}\n[&lt;span class='chapter-number'&gt;6&lt;/span&gt;  &lt;span class='chapter-title'&gt;JM Model Selection&lt;/span&gt;]{.hidden render-id=\"quarto-int-prev\"}\n[Working log]{.hidden render-id=\"quarto-int-sidebar:/index.html\"}\n[Introduction]{.hidden render-id=\"quarto-int-sidebar:/intro.html\"}\n[&lt;span class='chapter-number'&gt;1&lt;/span&gt;  &lt;span class='chapter-title'&gt;Table1&lt;/span&gt;]{.hidden render-id=\"quarto-int-sidebar:/01_table1.html\"}\n[&lt;span class='chapter-number'&gt;2&lt;/span&gt;  &lt;span class='chapter-title'&gt;JM&lt;/span&gt;]{.hidden render-id=\"quarto-int-sidebar:/02_jm.html\"}\n[&lt;span class='chapter-number'&gt;3&lt;/span&gt;  &lt;span class='chapter-title'&gt;Model selection&lt;/span&gt;]{.hidden render-id=\"quarto-int-sidebar:/03_model_selection.html\"}\n[&lt;span class='chapter-number'&gt;4&lt;/span&gt;  &lt;span class='chapter-title'&gt;JMBayes&lt;/span&gt;]{.hidden render-id=\"quarto-int-sidebar:/04_jmbayes.html\"}\n[&lt;span class='chapter-number'&gt;5&lt;/span&gt;  &lt;span class='chapter-title'&gt;JMbayes2&lt;/span&gt;]{.hidden render-id=\"quarto-int-sidebar:/05_jmbayes2.html\"}\n[&lt;span class='chapter-number'&gt;6&lt;/span&gt;  &lt;span class='chapter-title'&gt;JM Model Selection&lt;/span&gt;]{.hidden render-id=\"quarto-int-sidebar:/06_jm_model_selection.html\"}\n[&lt;span class='chapter-number'&gt;7&lt;/span&gt;  &lt;span class='chapter-title'&gt;AUC and ROC&lt;/span&gt;]{.hidden render-id=\"quarto-int-sidebar:/07_auc_roc.html\"}\n[&lt;span class='chapter-number'&gt;8&lt;/span&gt;  &lt;span class='chapter-title'&gt;Working log&lt;/span&gt;]{.hidden render-id=\"quarto-int-sidebar:/summary.html\"}\n[References]{.hidden render-id=\"quarto-int-sidebar:/references.html\"}\n[https://github.com/Goodgolden/tsa]{.hidden render-id=\"quarto-navbar-tools:https://github.com/Goodgolden/tsa\"}\n[&lt;span class='chapter-number'&gt;7&lt;/span&gt;  &lt;span class='chapter-title'&gt;AUC and ROC&lt;/span&gt;]{.hidden render-id=\"quarto-breadcrumbs-3bec5668364dcf5f77779309096b73d7\"}\n:::\n\n\n\n:::{#quarto-meta-markdown .hidden}\n[SWAN AMH project analysis - [7]{.chapter-number}  [AUC and ROC]{.chapter-title}]{.hidden render-id=\"quarto-metatitle\"}\n[SWAN AMH project analysis - [7]{.chapter-number}  [AUC and ROC]{.chapter-title}]{.hidden render-id=\"quarto-twittercardtitle\"}\n[SWAN AMH project analysis - [7]{.chapter-number}  [AUC and ROC]{.chapter-title}]{.hidden render-id=\"quarto-ogcardtitle\"}\n[SWAN AMH project analysis]{.hidden render-id=\"quarto-metasitename\"}\n[]{.hidden render-id=\"quarto-twittercarddesc\"}\n[]{.hidden render-id=\"quarto-ogcardddesc\"}\n:::\n\n\n\n\n&lt;!-- --&gt;\n\n::: {.quarto-embedded-source-code}\n```````````````````{.markdown shortcodes=\"false\"}\n---\ntitle: \"AUC and ROC\"\n---\n\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE,\n                      warnings = FALSE,\n                      message = FALSE,\n                      comment = \"#&gt;\",\n                      cache = TRUE,\n                      #results = \"hide\",\n                      digits = 4,\n                      error = FALSE)\n\n# ## clean the R environment\n# graphics.off()\n# rm(list = ls())\n# freshr::freshr()\n\n## load packages\nlibrary(here, quietly = TRUE)\nlibrary(tidyverse, quietly = TRUE)\nlibrary(JMbayes, quietly = TRUE)\ndevtools::load_all()\n\n## check the directory for the file\n# here::dr_here()\nhere::set_here()\n\n## the figure or results should be saved \n# paste0(\"foldername/Sfilename_workingresult_\", \n#      Sys.Date(), \".filetype\")\n{css, \"css-setup\", echo=FALSE} .scroll-100 {   max-height: 300px;   max-width: 1000px;   overflow-y: auto;   background-color: inherit; }"
  },
  {
    "objectID": "07_auc_roc.html#fit-the-joint-model-1",
    "href": "07_auc_roc.html#fit-the-joint-model-1",
    "title": "\n7  AUC and ROC\n",
    "section": "\n7.3 Fit the joint model",
    "text": "7.3 Fit the joint model\nHere is the joint model with JMbayes2, the name of the model is set up as package + [fit] + lme_number + surv_number\n\\(lme.fit1 \\sim (fixed = lamh \\sim time, \\ random = \\sim time| id)\\)\n\\(surv.fit16 \\sim coxph(Surv(etime, event) \\sim married + bc\\_pills + bmi + factor(site) + factor(ethnic) + factor(smoke))\\)\nquarto-executable-code-5450563D\n#| label: \"fit_joint_model\"\n#| cache: TRUE\n\ncontrol = lmeControl(opt = \"optim\")\nlme.fit1 &lt;- lme(lamh ~ time,\n                data = swan_amh00,\n                control = control,\n                random = ~ time| id)\n\n## testing for health\nsurv.fit16 &lt;- coxph(Surv(etime, event) ~ married + bc_pills + bmi +\n                      factor(site_ethnic) + factor(smoke),\n                    data = swan_amh11, \n                    x = TRUE,\n                    model = TRUE)\n\n\njmcontrol &lt;- list(n_iter = 5000, \n                  n_burnin = 1000, \n                  n_chains = 1,\n                  seed = 55555,\n                  cores = 1)\n\njmbayes2.fit116 &lt;- JMbayes2::jm(Surv_object = surv.fit16,\n                               Mixed_objects = lme.fit1, \n                               time_var = \"time\",\n                               control = jmcontrol) \n\n7.3.1 Summary for the jmbayes.fit116\n\nquarto-executable-code-5450563D\n#| label: \"summary_joint_model\"\n\nsummary(jmbayes2.fit116)[1]"
  },
  {
    "objectID": "07_auc_roc.html#predictive-accuracy-measures-1",
    "href": "07_auc_roc.html#predictive-accuracy-measures-1",
    "title": "\n7  AUC and ROC\n",
    "section": "\n7.4 Predictive accuracy measures",
    "text": "7.4 Predictive accuracy measures\nThe materials are directly from Dimitris Rizopoulos & Grigorios Papageorg (details seen JMwithR notes 6.3)\n\nDiscrimination: sensitivity, specificity, ROC and AUC\nCalibration: comparison between predicted and observed probabilities\nOverall: combination of discrimination and calibration\n\nSidenotes: we do not have right censor (possessively considering the left censor)\nTo estimate the sensitivity, specificity and the AUC, we need to account for censoring. Two main approaches: - model-based weights - Advantage: it allows censoring to depend on the longitudinal history (in any possible manner) - Disadvantage: it requires that the model is well calibrated\n\n\ninverse probability of censoring weighting (IPCW) (using Kaplan-Meier or other non-parametric estimators)\n\nAdvantage: it provides unbiased estimates even when the model is misspecified\nDisadvantage: it requires that the model for the weights is correct\nin settings where joint models are used, challenging because censoring may depend on the longitudinal outcomes in a complex manner\n\n\n\n\n:::"
  },
  {
    "objectID": "07_auc_roc.html#dynamic-prediction",
    "href": "07_auc_roc.html#dynamic-prediction",
    "title": "\n7  AUC and ROC\n",
    "section": "\n7.2 Dynamic prediction",
    "text": "7.2 Dynamic prediction\nIndividualized predictions of survival probabilities are computed by function predict(), this is different from JMbayes and JM.\n\n7.2.1 Individual dynamic prediction with plot\n\nCodet0 &lt;- 6\nids &lt;- unique(swan_amh02$id)\n## length(ids)\n## Prediction for the survival outcomes\n## This is the dataset with longitudinal outcomes\nnid &lt;- swan_amh02[swan_amh02$id == ids[8], ]\nnid &lt;- nid[nid$time &lt; t0, ]\nnid$event &lt;- 0\nnid$etime &lt;- t0\n\n# predictions for the longitudinal outcomes using newdata\nLpred1 &lt;- predict(jmbayes2.fit116, \n                    newdata = nid,\n                    return_newdata = TRUE)\n\n# predictions for the longitudinal outcomes at future time points\n# from year 6 to 10\nLpred2 &lt;- predict(jmbayes2.fit116, \n                    newdata = nid,\n                   times = seq(t0, 10, length.out = 51),\n                    return_newdata = TRUE)\n\nSpred &lt;- predict(jmbayes2.fit116, \n                 newdata = nid,\n                 times = seq(t0, 10, length.out = 11),\n                 process = \"event\",\n                 return_newdata = TRUE)\n\n\n\nCodedpplot &lt;- function(id_num,\n                   tmin = 0,\n                   tmax = 12,\n                   jmfit = jmbayes2.fit116,\n                   ...){\n\n  # browser()\n  nid0 &lt;- swan_amh02[swan_amh02$id == ids[id_num], ]\n  \n  nid &lt;- nid0\n  nid &lt;- nid[nid$time &lt; tmin, ]\n  nid$event &lt;- 0\n  nid$etime &lt;- tmin\n  \n  Lpred &lt;- predict(jmfit, \n                    newdata = nid,\n                   times = seq(tmin, tmax, length.out = 11),\n                    return_newdata = TRUE)\n  Spred &lt;- predict(jmfit, \n                 newdata = nid,\n                 times = seq(tmin, tmax, length.out = 11),\n                 process = \"event\",\n                 return_newdata = TRUE)\n  \n  # tAUC &lt;- try(JMbayes2::tvAUC(jmfit, \n  #                         nid0, \n  #                         Tstart = tmin,\n  #                         Dt = 10))\n  # \n  # tROC &lt;- try(JMbayes2::tvROC(jmfit, \n  #                         nid0, \n  #                         Tstart = tmin,\n  #                         Dt = 10))\n  # \n  # brier &lt;- try(JMbayes2::tvBrier(jmfit, \n  #                            nid0, \n  #                            Tstart = tmin,\n  #                            Dt = 10))\n  \n  plot(Lpred, Spred)\n  \n  return(list(Lpred = Lpred2,\n              Spred = Spred,\n              nid0 = nid0,\n              nid = nid))\n}\n\n\n\nCodedpplot_t4 &lt;- map(c(5, 8, 20, 55), \n               ~dpplot(id_num = .x,\n                       tmin = 4, \n                       tmax = 12, \n                       jmfit = jmbayes2.fit116))\ndpplot_t8 &lt;- map(c(5, 8, 20, 55),\n               ~dpplot(id_num = .x,\n                       tmin = 8,\n                       tmax = 12,\n                       jmfit = jmbayes2.fit116))\n# plot(Lpred1)\n# \n# plot(Lpred2)\n# \n# # prediction for the event outcome\n# plot(Spred)\n\n# combined into one plot, \n# the first longitudinal outcome and cumulative risk\n# the first two longitudinal outcomes\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n7.2.2 Predictive accuracy measures\nThe materials are directly from Dimitris Rizopoulos & Grigorios Papageorg (details seen JMwithR notes 6.3)\n\nDiscrimination: sensitivity, specificity, ROC and AUC\nCalibration: comparison between predicted and observed probabilities\nOverall: combination of discrimination and calibration\n\nSidenotes: we do not have right censor (possessively considering the left censor)\nTo estimate the sensitivity, specificity and the AUC, we need to account for censoring. Two main approaches:\n\n\nmodel-based weights\n\nAdvantage: it allows censoring to depend on the longitudinal history (in any possible manner)\nDisadvantage: it requires that the model is well calibrated\n\n\n\ninverse probability of censoring weighting (IPCW) (using Kaplan-Meier or other non-parametric estimators)\n\nAdvantage: it provides unbiased estimates even when the model is misspecified\nDisadvantage: it requires that the model for the weights is correct\nin settings where joint models are used, challenging because censoring may depend on the longitudinal outcomes in a complex manner\n\n\n\n\nCodeAUC &lt;- try(JMbayes2::tvAUC(jmbayes2.fit116,\n                          swan_amh02,\n                          Tstart = 4,\n                          Dt = 8))\nAUC\n\n#&gt; \n#&gt;  Time-dependent AUC for the Joint Model jmbayes2.fit116\n#&gt; \n#&gt; Estimated AUC: 0.7562\n#&gt; At time: 12\n#&gt; Using information up to time: 4 (324 subjects still at risk)\n\n\n\nCodeROC &lt;- try(JMbayes2::tvROC(jmbayes2.fit116,\n                          swan_amh02,\n                          Tstart = 6,\n                          Dt = 2))\nROC\n\n#&gt; \n#&gt;  Time-dependent Sensitivity and Specificity for the Joint Model jmbayes2.fit116\n#&gt; \n#&gt; At time: 8\n#&gt; Using information up to time: 6 (467 subjects still at risk)\n#&gt; \n#&gt;    cut-off         SN        SP        qSN        qSP  \n#&gt; 1     0.03 0.01754386 1.0000000 0.01543558 1.00000000  \n#&gt; 2     0.07 0.03508772 1.0000000 0.03093756 1.00000000  \n#&gt; 3     0.12 0.05263158 1.0000000 0.04650635 1.00000000  \n#&gt; 4     0.17 0.05263158 0.9975610 0.04444697 0.71524390  \n#&gt; 5     0.21 0.05263158 0.9951220 0.04237867 0.54439024  \n#&gt; 6     0.24 0.05263158 0.9926829 0.04030140 0.43048780  \n#&gt; 7     0.25 0.07017544 0.9926829 0.05602593 0.51184669  \n#&gt; 8     0.30 0.07017544 0.9902439 0.05396935 0.43048780  \n#&gt; 9     0.34 0.07017544 0.9878049 0.05190378 0.36720867  \n#&gt; 10    0.37 0.07017544 0.9853659 0.04982917 0.31658537  \n#&gt; 11    0.41 0.08771930 0.9853659 0.06571253 0.37871397  \n#&gt; 12    0.46 0.12280702 0.9829268 0.09569730 0.43048780  \n#&gt; 13    0.47 0.14035088 0.9804878 0.10985335 0.43048780  \n#&gt; 14    0.49 0.17543860 0.9804878 0.14238268 0.49376694  \n#&gt; 15    0.51 0.17543860 0.9731707 0.13661396 0.40336818  \n#&gt; 16    0.52 0.19298246 0.9707317 0.15117749 0.40572641  \n#&gt; 17    0.53 0.19298246 0.9682927 0.14926142 0.38302846  \n#&gt; 18    0.56 0.22807018 0.9682927 0.18255957 0.43048780  \n#&gt; 19    0.57 0.22807018 0.9634146 0.17883547 0.38980836  \n#&gt; 20    0.58 0.22807018 0.9609756 0.17696067 0.37157275  \n#&gt; 21    0.59 0.24561404 0.9585366 0.19197650 0.37537372  \n#&gt; 22    0.60 0.24561404 0.9560976 0.19011898 0.35929878  \n#&gt; 23    0.62 0.28070175 0.9536585 0.22242528 0.38167247  \n#&gt; 24    0.63 0.28070175 0.9487805 0.21880865 0.35352670  \n#&gt; 25    0.64 0.33333333 0.9463415 0.26917058 0.38881618  \n#&gt; 26    0.65 0.33333333 0.9439024 0.26745098 0.37624855  \n#&gt; 27    0.66 0.35087719 0.9390244 0.28165794 0.36720867  \n#&gt; 28    0.67 0.36842105 0.9365854 0.29774436 0.36990140  \n#&gt; 29    0.68 0.36842105 0.9317073 0.29438429 0.34912892  \n#&gt; 30    0.69 0.40350877 0.9317073 0.33038124 0.37465328  \n#&gt; 31    0.70 0.42105263 0.9292683 0.34693618 0.37676024  \n#&gt; 32    0.71 0.43859649 0.9268293 0.36365185 0.37871397  \n#&gt; 33    0.72 0.45614035 0.9243902 0.38053059 0.38053059  \n#&gt; 34    0.73 0.47368421 0.9195122 0.39609466 0.37353659  \n#&gt; 35    0.74 0.47368421 0.9121951 0.39161021 0.34912892  \n#&gt; 36    0.75 0.47368421 0.9073171 0.38858340 0.33410882  \n#&gt; 37    0.76 0.49122807 0.9000000 0.40302389 0.32318841  \n#&gt; 38    0.77 0.54385965 0.8975610 0.45934634 0.34467090  \n#&gt; 39    0.78 0.54385965 0.8902439 0.45519810 0.32557766  \n#&gt; 40    0.79 0.56140351 0.8878049 0.47345871 0.32826767  \n#&gt; 41    0.80 0.57894737 0.8731707 0.48525765 0.30318508  \n#&gt; 42    0.81 0.61403509 0.8707317 0.52441790 0.31399667  \n#&gt; 43    0.82 0.61403509 0.8585366 0.51805986 0.28964070  \n#&gt; 44    0.83 0.64912281 0.8536585 0.55713608 0.29544883  \n#&gt; 45    0.84 0.68421053 0.8512195 0.59816435 0.30519512  \n#&gt; 46    0.85 0.70175439 0.8390244 0.61418088 0.29079613  \n#&gt; 47    0.86 0.71929825 0.8268293 0.63073882 0.27793990  \n#&gt; 48    0.87 0.73684211 0.8121951 0.64685420 0.26298422  \n#&gt; 49    0.88 0.73684211 0.8000000 0.64170631 0.24677419  \n#&gt; 50    0.89 0.77192982 0.7731707 0.67724615 0.22679366  \n#&gt; 51    0.90 0.80701754 0.7560976 0.71924359 0.21984631 *\n#&gt; 52    0.91 0.80701754 0.7390244 0.71298469 0.20342739  \n#&gt; 53    0.92 0.82456140 0.7024390 0.72506770 0.17774571  \n#&gt; 54    0.93 0.87719298 0.6682927 0.79590435 0.16716496  \n#&gt; 55    0.94 0.87719298 0.6146341 0.77856804 0.13477955  \n#&gt; 56    0.95 0.87719298 0.5536585 0.75491078 0.10540144  \n#&gt; 57    0.96 0.89473684 0.4804878 0.75784288 0.08101441  \n#&gt; 58    0.97 0.92982456 0.3951220 0.80257874 0.06153472  \n#&gt; 59    0.98 0.94736842 0.2658537 0.78054511 0.03423566  \n#&gt; 60    0.99 0.98245614 0.1000000 0.80492899 0.01105882\n\n\n\nCodeBS &lt;- map(dpplot_t4, \"nid0\") %&gt;%\n  map(~try(JMbayes2::tvBrier(jmbayes2.fit116,\n                          .x,\n                          Tstart = 4,\n                          Dt = 6)))\n\n#&gt; Warning in br(Thoriz): there are fewer than 5 subjects with an event in the interval [4.000001, 10).\n\n\n#&gt; Error in br(Thoriz) : \n#&gt;   it seems that there are no events in the interval [4.000001, 10).\n#&gt; \n#&gt; Error in br(Thoriz) : \n#&gt;   it seems that there are no events in the interval [4.000001, 10).\n\n\n#&gt; Warning in br(Thoriz): there are fewer than 5 subjects with an event in the interval [4.000001, 10).\n\nCodeBS\n\n#&gt; [[1]]\n#&gt; \n#&gt; Prediction Error for the Joint Model 'jmbayes2.fit116'\n#&gt; \n#&gt; Estimated Brier score: 0.0032\n#&gt; At time: 10\n#&gt; For the 1 subjects at risk at time 4\n#&gt; Number of subjects with an event in [4, 10): 1\n#&gt; Number of subjects with a censored time in [4, 10): 0\n#&gt; Accounting for censoring using model-based weights\n#&gt; \n#&gt; \n#&gt; [[2]]\n#&gt; [1] \"Error in br(Thoriz) : \\n  it seems that there are no events in the interval [4.000001, 10).\\n\\n\"\n#&gt; attr(,\"class\")\n#&gt; [1] \"try-error\"\n#&gt; attr(,\"condition\")\n#&gt; &lt;simpleError in br(Thoriz): it seems that there are no events in the interval [4.000001, 10).\n#&gt; &gt;\n#&gt; \n#&gt; [[3]]\n#&gt; [1] \"Error in br(Thoriz) : \\n  it seems that there are no events in the interval [4.000001, 10).\\n\\n\"\n#&gt; attr(,\"class\")\n#&gt; [1] \"try-error\"\n#&gt; attr(,\"condition\")\n#&gt; &lt;simpleError in br(Thoriz): it seems that there are no events in the interval [4.000001, 10).\n#&gt; &gt;\n#&gt; \n#&gt; [[4]]\n#&gt; \n#&gt; Prediction Error for the Joint Model 'jmbayes2.fit116'\n#&gt; \n#&gt; Estimated Brier score: 0.1256\n#&gt; At time: 10\n#&gt; For the 1 subjects at risk at time 4\n#&gt; Number of subjects with an event in [4, 10): 1\n#&gt; Number of subjects with a censored time in [4, 10): 0\n#&gt; Accounting for censoring using model-based weights"
  }
]